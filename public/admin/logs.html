<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logs de Actividad - Admin Excentrica</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/admin/admin.css">
    <style>
        .logs-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        .logs-filters select,
        .logs-filters input {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        .logs-filters input[type="date"] {
            min-width: 140px;
        }
        .log-entry {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .log-entry:hover {
            background: var(--bg-secondary);
        }
        .log-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .log-icon.create { background: rgba(16, 185, 129, 0.2); }
        .log-icon.update { background: rgba(59, 130, 246, 0.2); }
        .log-icon.delete { background: rgba(239, 68, 68, 0.2); }
        .log-icon.approve { background: rgba(16, 185, 129, 0.2); }
        .log-icon.reject { background: rgba(239, 68, 68, 0.2); }
        .log-icon.activate { background: rgba(16, 185, 129, 0.2); }
        .log-icon.deactivate { background: rgba(245, 158, 11, 0.2); }
        .log-content {
            flex: 1;
        }
        .log-action {
            font-weight: 600;
            color: var(--text-primary);
        }
        .log-entity {
            color: var(--primary);
        }
        .log-user {
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        .log-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
        }
        .log-details {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        .badge-role {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 0.5rem;
        }
        .badge-role.admin { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .badge-role.publicista { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .badge-role.editor { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .summary-card {
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            text-align: center;
        }
        .summary-card h4 {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <a href="/"><span>&#9889;</span> Excentrica</a>
                <span class="admin-badge">ADMIN</span>
            </div>
            <nav class="admin-nav">
                <a href="/admin/" class="admin-nav-item">
                    <span class="icon">&#128202;</span> Dashboard
                </a>
                <a href="/admin/usuarios.html" class="admin-nav-item">
                    <span class="icon">&#128101;</span> Usuarios
                </a>
                <a href="/admin/anuncios.html" class="admin-nav-item">
                    <span class="icon">&#128250;</span> Anuncios
                </a>
                <a href="/admin/almacenamiento.html" class="admin-nav-item">
                    <span class="icon">&#128190;</span> Almacenamiento
                </a>
                <a href="/admin/logs.html" class="admin-nav-item active">
                    <span class="icon">&#128220;</span> Logs
                </a>
                <div class="admin-nav-divider"></div>
                <a href="/" class="admin-nav-item">
                    <span class="icon">&#127968;</span> Volver al sitio
                </a>
                <a href="#" onclick="auth.logout(); return false;" class="admin-nav-item">
                    <span class="icon">&#128682;</span> Cerrar sesion
                </a>
            </nav>
        </aside>

        <!-- Main content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1>&#128220; Logs de Actividad</h1>
                <div class="admin-user">
                    <span id="user-name">Admin</span>
                </div>
            </header>

            <div class="admin-content">
                <!-- Summary -->
                <div class="summary-cards" id="summary-cards">
                    <div class="summary-card">
                        <h4>Actividad 24h</h4>
                        <div class="value" id="summary-total">-</div>
                    </div>
                    <div class="summary-card">
                        <h4>Aprobaciones</h4>
                        <div class="value" id="summary-approve">-</div>
                    </div>
                    <div class="summary-card">
                        <h4>Rechazos</h4>
                        <div class="value" id="summary-reject">-</div>
                    </div>
                    <div class="summary-card">
                        <h4>Creaciones</h4>
                        <div class="value" id="summary-create">-</div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="logs-filters">
                    <select id="filter-user">
                        <option value="">Todos los usuarios</option>
                    </select>
                    <select id="filter-role">
                        <option value="">Todos los roles</option>
                        <option value="admin">Admin</option>
                        <option value="publicista">Publicista</option>
                        <option value="editor">Editor</option>
                        <option value="periodista">Periodista</option>
                    </select>
                    <select id="filter-action">
                        <option value="">Todas las acciones</option>
                        <option value="create">Crear</option>
                        <option value="update">Actualizar</option>
                        <option value="delete">Eliminar</option>
                        <option value="approve">Aprobar</option>
                        <option value="reject">Rechazar</option>
                        <option value="activate">Activar</option>
                        <option value="deactivate">Desactivar</option>
                    </select>
                    <select id="filter-entity">
                        <option value="">Todas las entidades</option>
                        <option value="ad">Anuncios</option>
                        <option value="registration">Inscripciones</option>
                        <option value="event">Eventos</option>
                        <option value="user">Usuarios</option>
                    </select>
                    <input type="date" id="filter-date-from" placeholder="Desde">
                    <input type="date" id="filter-date-to" placeholder="Hasta">
                    <button class="btn btn-primary btn-sm" onclick="loadLogs()">Filtrar</button>
                    <button class="btn btn-outline btn-sm" onclick="clearFilters()">Limpiar</button>
                </div>

                <!-- Logs list -->
                <div class="card">
                    <div class="card-body">
                        <div id="logs-container">
                            <div class="text-center p-4"><div class="spinner"></div></div>
                        </div>
                        <div id="pagination" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/components.js"></script>
    <script>
        // Verificar admin
        if (!auth.requireAdmin()) {
            // Se redirige automaticamente
        }

        document.getElementById('user-name').textContent = auth.getUser()?.name || 'Admin';

        let currentPage = 1;
        const perPage = 50;

        const actionLabels = {
            create: 'Creo',
            update: 'Actualizo',
            delete: 'Elimino',
            approve: 'Aprobo',
            reject: 'Rechazo',
            activate: 'Activo',
            deactivate: 'Desactivo',
            verify: 'Verifico'
        };

        const actionIcons = {
            create: '&#10133;',
            update: '&#9998;',
            delete: '&#128465;',
            approve: '&#9989;',
            reject: '&#10060;',
            activate: '&#9989;',
            deactivate: '&#9888;',
            verify: '&#128269;'
        };

        const entityLabels = {
            ad: 'anuncio',
            registration: 'inscripcion',
            event: 'evento',
            user: 'usuario',
            news: 'noticia',
            product: 'producto'
        };

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('es-AR', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function loadSummary() {
            try {
                const response = await api.get('/api/admin/logs/summary');
                if (response.success) {
                    const data = response.data.last_24h;
                    document.getElementById('summary-total').textContent = data.total || 0;

                    const byAction = data.by_action || [];
                    const approve = byAction.find(a => a.action === 'approve')?.count || 0;
                    const reject = byAction.find(a => a.action === 'reject')?.count || 0;
                    const create = byAction.find(a => a.action === 'create')?.count || 0;

                    document.getElementById('summary-approve').textContent = approve;
                    document.getElementById('summary-reject').textContent = reject;
                    document.getElementById('summary-create').textContent = create;
                }
            } catch (e) {
                console.error('Error loading summary:', e);
            }
        }

        async function loadUsers() {
            try {
                const response = await api.get('/api/admin/logs/users');
                if (response.success) {
                    const select = document.getElementById('filter-user');
                    select.innerHTML = '<option value="">Todos los usuarios</option>';
                    response.data.users.forEach(u => {
                        const option = document.createElement('option');
                        option.value = u.user_id;
                        option.textContent = `${u.user_name} (${u.user_role})`;
                        select.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('Error loading users:', e);
            }
        }

        async function loadLogs(page = 1) {
            currentPage = page;
            const container = document.getElementById('logs-container');
            container.innerHTML = '<div class="text-center p-4"><div class="spinner"></div></div>';

            try {
                const params = {
                    page,
                    limit: perPage,
                    user_id: document.getElementById('filter-user').value,
                    user_role: document.getElementById('filter-role').value,
                    action: document.getElementById('filter-action').value,
                    entity_type: document.getElementById('filter-entity').value,
                    date_from: document.getElementById('filter-date-from').value,
                    date_to: document.getElementById('filter-date-to').value
                };

                // Limpiar params vacios
                Object.keys(params).forEach(k => !params[k] && delete params[k]);

                const response = await api.get('/api/admin/logs', params);

                if (response.success) {
                    const logs = response.data.logs;
                    const pagination = response.data.pagination;

                    if (logs.length === 0) {
                        container.innerHTML = '<p class="text-center text-muted p-4">No se encontraron logs</p>';
                        return;
                    }

                    container.innerHTML = logs.map(log => {
                        let details = '';
                        try {
                            const d = JSON.parse(log.details || '{}');
                            if (d.old_status && d.new_status) {
                                details = `${d.old_status} â†’ ${d.new_status}`;
                            }
                        } catch(e) {}

                        return `
                            <div class="log-entry">
                                <div class="log-icon ${log.action}">${actionIcons[log.action] || '&#128196;'}</div>
                                <div class="log-content">
                                    <div>
                                        <span class="log-action">${actionLabels[log.action] || log.action}</span>
                                        <span class="log-entity">${entityLabels[log.entity_type] || log.entity_type}</span>
                                        ${log.entity_name ? `: <strong>${Utils.escapeHtml(log.entity_name)}</strong>` : ''}
                                    </div>
                                    <div class="log-user">
                                        ${Utils.escapeHtml(log.user_name)}
                                        <span class="badge-role ${log.user_role}">${log.user_role}</span>
                                    </div>
                                    ${details ? `<div class="log-details">${details}</div>` : ''}
                                </div>
                                <div class="log-time">${formatDateTime(log.created_at)}</div>
                            </div>
                        `;
                    }).join('');

                    // Paginacion
                    renderPagination(pagination);
                }
            } catch (e) {
                console.error('Error loading logs:', e);
                container.innerHTML = '<p class="text-center text-danger p-4">Error cargando logs</p>';
            }
        }

        function renderPagination(pagination) {
            const container = document.getElementById('pagination');
            if (pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '<div class="d-flex justify-content-center gap-2">';

            if (pagination.page > 1) {
                html += `<button class="btn btn-outline btn-sm" onclick="loadLogs(${pagination.page - 1})">Anterior</button>`;
            }

            html += `<span class="p-2">Pagina ${pagination.page} de ${pagination.pages}</span>`;

            if (pagination.page < pagination.pages) {
                html += `<button class="btn btn-outline btn-sm" onclick="loadLogs(${pagination.page + 1})">Siguiente</button>`;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function clearFilters() {
            document.getElementById('filter-user').value = '';
            document.getElementById('filter-role').value = '';
            document.getElementById('filter-action').value = '';
            document.getElementById('filter-entity').value = '';
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            loadLogs(1);
        }

        // Inicializar
        loadSummary();
        loadUsers();
        loadLogs();
    </script>
</body>
</html>
