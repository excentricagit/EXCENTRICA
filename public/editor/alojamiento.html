<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alojamiento - Editor Excentrica</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/editor/editor.css">
    <style>
        #alojamiento-modal {
            max-width: 900px;
            width: 95%;
        }

        .modal-3col {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.25rem;
        }

        @media (max-width: 900px) {
            .modal-3col { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 600px) {
            .modal-3col { grid-template-columns: 1fr; }
        }

        .modal-col {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .modal-col h4 {
            color: #a855f7;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0;
            padding-bottom: 0.4rem;
            border-bottom: 1px solid rgba(168, 85, 247, 0.3);
        }

        .modal-col .form-group { margin-bottom: 0; }
        .modal-col .form-group label { font-size: 0.75rem; margin-bottom: 0.2rem; }
        .modal-col .form-control { padding: 0.4rem 0.6rem; font-size: 0.85rem; }
        .modal-col textarea.form-control { min-height: 50px; }

        .image-preview-container {
            width: 100%;
            aspect-ratio: 4/3;
            border: 2px dashed rgba(168, 85, 247, 0.3);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-preview-container:hover {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        .image-preview-container img { width: 100%; height: 100%; object-fit: cover; }
        .image-preview-container .placeholder { color: rgba(255, 255, 255, 0.5); text-align: center; padding: 0.5rem; font-size: 0.8rem; }
        .image-preview-container .placeholder span { font-size: 1.5rem; display: block; margin-bottom: 0.25rem; }

        .featured-check {
            background: rgba(251, 191, 36, 0.1) !important;
            border: 1px solid rgba(251, 191, 36, 0.3) !important;
        }
        .featured-check label { color: #fbbf24 !important; }

        .badge-pending { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .badge-approved { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .badge-rejected { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .featured-star { color: #fbbf24; }

        .alojamiento-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .alojamiento-card {
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .alojamiento-card:hover {
            border-color: rgba(168, 85, 247, 0.5);
            transform: translateY(-2px);
        }

        .alojamiento-card-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: rgba(0, 0, 0, 0.3);
        }

        .alojamiento-card-body { padding: 1rem; }

        .alojamiento-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .alojamiento-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }

        .alojamiento-card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .alojamiento-card-actions {
            display: flex;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .alojamiento-card-actions .btn { flex: 1; }

        .service-checkbox {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            cursor: pointer;
        }
        .service-checkbox input { accent-color: #a855f7; }
        .service-checkbox label { cursor: pointer; font-size: 0.75rem; }

        .star-selector {
            display: flex;
            gap: 0.25rem;
        }
        .star-selector .star {
            font-size: 1.5rem;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease;
        }
        .star-selector .star:hover,
        .star-selector .star.active {
            color: #fbbf24;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <a href="/"><span>EX</span> Excentrica</a>
                <span class="admin-badge">EDITOR</span>
            </div>
            <nav class="admin-nav">
                <a href="/editor/" class="admin-nav-item">
                    <span class="icon">üìä</span> Dashboard
                </a>
                <a href="/editor/noticias.html" class="admin-nav-item">
                    <span class="icon">üì∞</span> Noticias
                </a>
                <a href="/editor/productos.html" class="admin-nav-item">
                    <span class="icon">üõí</span> Productos
                </a>
                <a href="/editor/eventos.html" class="admin-nav-item">
                    <span class="icon">üìÖ</span> Eventos
                </a>
                <a href="/editor/categorias.html" class="admin-nav-item">
                    <span class="icon">üìÅ</span> Categor√≠as
                </a>
                <a href="/editor/zonas.html" class="admin-nav-item">
                    <span class="icon">üìç</span> Zonas
                </a>
                <a href="/editor/cine.html" class="admin-nav-item">
                    <span class="icon">üé¨</span> Cine
                </a>
                <a href="/editor/gastronomia.html" class="admin-nav-item">
                    <span class="icon">üçΩÔ∏è</span> Gastronom√≠a
                </a>
                <a href="/editor/alojamiento.html" class="admin-nav-item active">
                    <span class="icon">üè®</span> Alojamiento
                </a>
                <a href="/editor/transporte.html" class="admin-nav-item">
                    <span class="icon">üöå</span> Transporte
                </a>
                <a href="/editor/servicios.html" class="admin-nav-item">
                    <span class="icon">üîß</span> Servicios
                </a>
                <a href="/editor/puntos-interes.html" class="admin-nav-item">
                    <span class="icon">üìç</span> Turismo
                </a>
                <div class="admin-nav-divider"></div>
                <a href="/" class="admin-nav-item">
                    <span class="icon">üè†</span> Volver al sitio
                </a>
                <a href="#" onclick="auth.logout(); return false;" class="admin-nav-item">
                    <span class="icon">üö™</span> Cerrar sesi√≥n
                </a>
            </nav>
        </aside>

        <main class="admin-main">
            <header class="admin-header">
                <h1>Gestion de Alojamiento v2</h1>
                <div class="admin-user">
                    <span id="user-name">Editor</span>
                    <button class="btn btn-primary btn-sm" onclick="showCreateModal()">+ Nuevo Alojamiento</button>
                </div>
            </header>

            <div class="admin-content">
                <div class="stats-grid mb-4">
                    <div class="stat-card">
                        <div class="stat-icon">A</div>
                        <div class="stat-info">
                            <span class="stat-value" id="total-items">0</span>
                            <span class="stat-label">Total</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">OK</div>
                        <div class="stat-info">
                            <span class="stat-value" id="approved-items">0</span>
                            <span class="stat-label">Aprobados</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">...</div>
                        <div class="stat-info">
                            <span class="stat-value" id="pending-items">0</span>
                            <span class="stat-label">Pendientes</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">*</div>
                        <div class="stat-info">
                            <span class="stat-value" id="featured-items">0</span>
                            <span class="stat-label">Destacados</span>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-3 mb-4 flex-wrap">
                    <input type="text" id="search" class="form-control" placeholder="Buscar..." style="max-width: 200px;">
                    <select id="filter-category" class="form-control" style="max-width: 180px;">
                        <option value="">Todas las categorias</option>
                        <option value="hotel">üè® Hotel</option>
                        <option value="apart-hotel">üè¢ Apart Hotel</option>
                        <option value="hostel">üõèÔ∏è Hostel</option>
                        <option value="cabanas">üè° Cabanas</option>
                        <option value="departamento">üè† Departamento</option>
                        <option value="residencial">üèòÔ∏è Residencial</option>
                        <option value="bed-breakfast">üõãÔ∏è B&B</option>
                        <option value="motel">üÖøÔ∏è Motel</option>
                        <option value="camping">‚õ∫ Camping</option>
                        <option value="estancia">üåæ Estancia</option>
                    </select>
                    <select id="filter-status" class="form-control" style="max-width: 150px;">
                        <option value="">Todos los estados</option>
                        <option value="pending">Pendiente</option>
                        <option value="approved">Aprobado</option>
                        <option value="rejected">Rechazado</option>
                    </select>
                    <select id="filter-zone" class="form-control" style="max-width: 180px;">
                        <option value="">Todas las zonas</option>
                    </select>
                    <button class="btn btn-outline btn-sm" onclick="resetFilters()">Limpiar</button>
                </div>

                <div id="content-container">
                    <div class="text-center p-4"><div class="spinner"></div></div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-backdrop" id="modal-backdrop" onclick="closeModal()"></div>
    <div class="modal" id="alojamiento-modal">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">Nuevo Alojamiento</h3>
            <span class="modal-close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="alojamiento-form" onsubmit="saveItem(event)">
                <input type="hidden" id="item-id">

                <div class="modal-3col">
                    <div class="modal-col">
                        <h4>Info Basica</h4>
                        <div class="form-group">
                            <label for="item-name">Nombre *</label>
                            <input type="text" id="item-name" class="form-control" required placeholder="Nombre">
                        </div>
                        <div class="form-group">
                            <label for="item-type">Tipo de Alojamiento *</label>
                            <select id="item-type" class="form-control" required>
                                <option value="hotel">üè® Hotel</option>
                                <option value="apart-hotel">üè¢ Apart Hotel</option>
                                <option value="hostel">üõèÔ∏è Hostel</option>
                                <option value="cabanas">üè° Cabanas</option>
                                <option value="departamento">üè† Departamento</option>
                                <option value="residencial">üèòÔ∏è Residencial</option>
                                <option value="bed-breakfast">üõãÔ∏è B&B</option>
                                <option value="motel">üÖøÔ∏è Motel</option>
                                <option value="camping">‚õ∫ Camping</option>
                                <option value="estancia">üåæ Estancia</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="item-description">Descripcion</label>
                            <textarea id="item-description" class="form-control" rows="2" placeholder="Descripcion..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="item-price">Precio por noche</label>
                            <input type="number" id="item-price" class="form-control" placeholder="15000">
                        </div>
                        <div class="form-group">
                            <label>Estrellas</label>
                            <div class="star-selector" id="star-selector">
                                <span class="star" data-value="1">&#9733;</span>
                                <span class="star" data-value="2">&#9733;</span>
                                <span class="star" data-value="3">&#9733;</span>
                                <span class="star" data-value="4">&#9733;</span>
                                <span class="star" data-value="5">&#9733;</span>
                            </div>
                            <input type="hidden" id="item-star-rating" value="0">
                        </div>
                    </div>

                    <div class="modal-col">
                        <h4>Ubicacion y Contacto</h4>
                        <div class="form-group">
                            <label for="item-zone">Zona</label>
                            <select id="item-zone" class="form-control">
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="item-address">Direccion</label>
                            <input type="text" id="item-address" class="form-control" placeholder="Calle y numero">
                        </div>
                        <div class="form-group">
                            <label for="item-phone">Telefono</label>
                            <input type="tel" id="item-phone" class="form-control" placeholder="0385-4123456">
                        </div>
                        <div class="form-group">
                            <label for="item-email">Email</label>
                            <input type="email" id="item-email" class="form-control" placeholder="contacto@hotel.com">
                        </div>
                        <div class="form-group">
                            <label for="item-website">Sitio Web</label>
                            <input type="url" id="item-website" class="form-control" placeholder="https://...">
                        </div>
                    </div>

                    <div class="modal-col">
                        <h4>Imagen y Estado</h4>
                        <div class="form-group">
                            <div class="image-preview-container" onclick="document.getElementById('item-image-file').click()">
                                <div id="image-preview" class="placeholder">
                                    <span>+</span>
                                    Subir imagen
                                </div>
                            </div>
                            <input type="file" id="item-image-file" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                            <input type="hidden" id="item-image-url">
                        </div>
                        <div class="form-group">
                            <label for="item-status">Estado</label>
                            <select id="item-status" class="form-control">
                                <option value="pending">Pendiente</option>
                                <option value="approved">Aprobado</option>
                                <option value="rejected">Rechazado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <div class="service-checkbox featured-check">
                                <input type="checkbox" id="item-featured">
                                <label for="item-featured">Destacar</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button type="button" class="btn btn-outline btn-sm" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary btn-sm">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/components.js"></script>
    <script>
        if (!auth.getUser()) {}
        document.getElementById('user-name').textContent = auth.getUser()?.name || 'Editor';

        let allItems = [];
        let filteredItems = [];
        let zones = [];

        async function loadData() {
            try {
                const [itemsRes, zonesRes] = await Promise.all([
                    api.getAdminAccommodations(),
                    api.getAdminZones()
                ]);

                if (itemsRes.success) {
                    allItems = itemsRes.data.items || [];
                    applyFilters();
                    updateStats();
                }

                if (zonesRes.success) {
                    zones = Array.isArray(zonesRes.data) ? zonesRes.data : [];
                    renderZoneOptions();
                }
            } catch (e) {
                console.error('Error loading data:', e);
                Components.toast('Error cargando datos', 'error');
            }
        }

        function renderZoneOptions() {
            const filterZone = document.getElementById('filter-zone');
            filterZone.innerHTML = '<option value="">Todas las zonas</option>' +
                zones.map(z => `<option value="${z.id}">${z.name}</option>`).join('');

            const modalZone = document.getElementById('item-zone');
            modalZone.innerHTML = '<option value="">Seleccionar zona...</option>' +
                zones.map(z => `<option value="${z.id}">${z.name}</option>`).join('');
        }

        function updateStats() {
            document.getElementById('total-items').textContent = allItems.length;
            document.getElementById('approved-items').textContent = allItems.filter(i => i.status === 'approved').length;
            document.getElementById('pending-items').textContent = allItems.filter(i => i.status === 'pending').length;
            document.getElementById('featured-items').textContent = allItems.filter(i => i.featured).length;
        }

        function applyFilters() {
            const search = document.getElementById('search').value.toLowerCase();
            const category = document.getElementById('filter-category').value;
            const status = document.getElementById('filter-status').value;
            const zoneId = document.getElementById('filter-zone').value;

            filteredItems = allItems.filter(i => {
                const matchSearch = !search ||
                    i.name.toLowerCase().includes(search) ||
                    (i.description && i.description.toLowerCase().includes(search)) ||
                    (i.address && i.address.toLowerCase().includes(search));
                const matchCategory = !category || i.accommodation_type === category;
                const matchStatus = !status || i.status === status;
                const matchZone = !zoneId || i.zone_id == zoneId;
                return matchSearch && matchCategory && matchStatus && matchZone;
            });

            renderGrid();
        }

        function resetFilters() {
            document.getElementById('search').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-zone').value = '';
            applyFilters();
        }

        function renderGrid() {
            const container = document.getElementById('content-container');

            if (filteredItems.length === 0) {
                container.innerHTML = '<p class="text-center text-muted p-4">No se encontraron alojamientos</p>';
                return;
            }

            container.innerHTML = `
                <div class="alojamiento-grid">
                    ${filteredItems.map(i => `
                        <div class="alojamiento-card">
                            ${i.image_url ?
                                `<img src="${i.image_url}" class="alojamiento-card-image" alt="${i.name}">` :
                                `<div class="alojamiento-card-image" style="display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.3);">Sin imagen</div>`
                            }
                            <div class="alojamiento-card-body">
                                <div class="alojamiento-card-header">
                                    <h4 class="alojamiento-card-title">
                                        ${i.featured ? '<span class="featured-star">*</span> ' : ''}${i.name}
                                    </h4>
                                    <span class="badge badge-${i.status}">${getStatusLabel(i.status)}</span>
                                </div>
                                <div class="alojamiento-card-meta">
                                    ${i.accommodation_type ? `<span style="background: rgba(14,165,233,0.2); color: #38bdf8; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">${getTypeLabel(i.accommodation_type)}</span>` : ''}
                                    ${i.star_rating ? `<span>${'‚òÖ'.repeat(i.star_rating)}</span>` : ''}
                                    ${i.zone_name ? `<span>[Z] ${i.zone_name}</span>` : ''}
                                    ${i.price_per_night ? `<span>$${formatNumber(i.price_per_night)}/noche</span>` : ''}
                                </div>
                                <div class="alojamiento-card-actions">
                                    ${i.status === 'pending' ? `
                                        <button class="btn btn-sm btn-success" onclick="approveItem(${i.id})">Aprobar</button>
                                        <button class="btn btn-sm btn-danger" onclick="rejectItem(${i.id})">Rechazar</button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-outline" onclick="editItem(${i.id})">Editar</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteItem(${i.id})">Borrar</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getStatusLabel(status) {
            return { pending: 'Pendiente', approved: 'Aprobado', rejected: 'Rechazado' }[status] || status;
        }

        const ALOJA_TYPES = {
            'hotel': 'üè® Hotel',
            'apart-hotel': 'üè¢ Apart Hotel',
            'hostel': 'üõèÔ∏è Hostel',
            'cabanas': 'üè° Cabanas',
            'departamento': 'üè† Depto',
            'residencial': 'üèòÔ∏è Residencial',
            'bed-breakfast': 'üõãÔ∏è B&B',
            'motel': 'üÖøÔ∏è Motel',
            'camping': '‚õ∫ Camping',
            'estancia': 'üåæ Estancia'
        };

        function getTypeLabel(type) {
            return ALOJA_TYPES[type] || type;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('es-AR').format(num);
        }

        function openModal() {
            document.getElementById('alojamiento-modal').classList.add('active');
            document.getElementById('modal-backdrop').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('alojamiento-modal').classList.remove('active');
            document.getElementById('modal-backdrop').classList.remove('active');
            document.body.style.overflow = '';
        }

        function showCreateModal() {
            document.getElementById('modal-title').textContent = 'Nuevo Alojamiento';
            document.getElementById('alojamiento-form').reset();
            document.getElementById('item-id').value = '';
            document.getElementById('item-type').value = 'hotel';
            document.getElementById('item-status').value = 'pending';
            document.getElementById('item-image-url').value = '';
            document.getElementById('image-preview').innerHTML = '<span>+</span>Click para subir imagen';
            document.getElementById('image-preview').className = 'placeholder';
            setStarRating(0);
            openModal();
        }

        function editItem(id) {
            const i = allItems.find(x => x.id === id);
            if (!i) return;

            document.getElementById('modal-title').textContent = 'Editar Alojamiento';
            document.getElementById('item-id').value = i.id;
            document.getElementById('item-name').value = i.name || '';
            document.getElementById('item-type').value = i.accommodation_type || 'hotel';
            document.getElementById('item-description').value = i.description || '';
            document.getElementById('item-price').value = i.price_per_night || '';
            setStarRating(i.star_rating || 0);
            document.getElementById('item-zone').value = i.zone_id || '';
            document.getElementById('item-address').value = i.address || '';
            document.getElementById('item-phone').value = i.phone || '';
            document.getElementById('item-email').value = i.email || '';
            document.getElementById('item-website').value = i.website || '';
            document.getElementById('item-status').value = i.status || 'pending';
            document.getElementById('item-featured').checked = i.featured === 1;
            document.getElementById('item-image-url').value = i.image_url || '';

            if (i.image_url) {
                document.getElementById('image-preview').innerHTML = `<img src="${i.image_url}" alt="Preview">`;
                document.getElementById('image-preview').className = '';
            } else {
                document.getElementById('image-preview').innerHTML = '<span>+</span>Click para subir imagen';
                document.getElementById('image-preview').className = 'placeholder';
            }

            openModal();
        }

        function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        const base64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(base64);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                Components.toast('La imagen no puede superar 10MB', 'error');
                return;
            }

            const preview = document.getElementById('image-preview');
            preview.innerHTML = '<span>...</span>Procesando...';

            try {
                const base64 = await compressImage(file, 800, 0.7);
                document.getElementById('item-image-url').value = base64;
                preview.innerHTML = `<img src="${base64}" alt="Preview">`;
                preview.className = '';
            } catch (e) {
                Components.toast('Error procesando imagen', 'error');
                preview.innerHTML = '<span>+</span>Click para subir imagen';
                preview.className = 'placeholder';
            }
        }

        async function saveItem(event) {
            event.preventDefault();

            const id = document.getElementById('item-id').value;
            const data = {
                name: document.getElementById('item-name').value.trim(),
                accommodation_type: document.getElementById('item-type').value,
                description: document.getElementById('item-description').value.trim() || null,
                price_per_night: document.getElementById('item-price').value || null,
                star_rating: parseInt(document.getElementById('item-star-rating').value) || 0,
                zone_id: document.getElementById('item-zone').value || null,
                address: document.getElementById('item-address').value.trim() || null,
                phone: document.getElementById('item-phone').value.trim() || null,
                email: document.getElementById('item-email').value.trim() || null,
                website: document.getElementById('item-website').value.trim() || null,
                status: document.getElementById('item-status').value,
                featured: document.getElementById('item-featured').checked,
                image_url: document.getElementById('item-image-url').value || null
            };

            try {
                let response;
                if (id) {
                    response = await api.updateAccommodation(id, data);
                } else {
                    response = await api.createAccommodation(data);
                }

                if (response.success) {
                    Components.toast(id ? 'Alojamiento actualizado' : 'Alojamiento creado', 'success');
                    closeModal();
                    loadData();
                } else {
                    Components.toast(response.error || 'Error guardando', 'error');
                }
            } catch (e) {
                console.error('Error saving:', e);
                Components.toast(e.message || 'Error guardando', 'error');
            }
        }

        async function approveItem(id) {
            if (!confirm('Aprobar este alojamiento?')) return;
            try {
                const response = await api.updateAccommodationStatus(id, 'approved');
                if (response.success) {
                    Components.toast('Alojamiento aprobado', 'success');
                    loadData();
                }
            } catch (e) {
                Components.toast('Error aprobando', 'error');
            }
        }

        async function rejectItem(id) {
            if (!confirm('Rechazar este alojamiento?')) return;
            try {
                const response = await api.updateAccommodationStatus(id, 'rejected');
                if (response.success) {
                    Components.toast('Alojamiento rechazado', 'success');
                    loadData();
                }
            } catch (e) {
                Components.toast('Error rechazando', 'error');
            }
        }

        async function deleteItem(id) {
            if (!confirm('Eliminar este alojamiento?')) return;
            try {
                const response = await api.deleteAccommodation(id);
                if (response.success) {
                    Components.toast('Alojamiento eliminado', 'success');
                    loadData();
                }
            } catch (e) {
                Components.toast('Error eliminando', 'error');
            }
        }

        document.getElementById('search').addEventListener('input', applyFilters);
        document.getElementById('filter-category').addEventListener('change', applyFilters);
        document.getElementById('filter-status').addEventListener('change', applyFilters);
        document.getElementById('filter-zone').addEventListener('change', applyFilters);

        // Star selector
        document.querySelectorAll('.star-selector .star').forEach(star => {
            star.addEventListener('click', function() {
                const value = parseInt(this.dataset.value);
                setStarRating(value);
            });
        });

        function setStarRating(value) {
            document.getElementById('item-star-rating').value = value;
            document.querySelectorAll('.star-selector .star').forEach(star => {
                const starValue = parseInt(star.dataset.value);
                star.classList.toggle('active', starValue <= value);
            });
        }

        loadData();
    </script>
</body>
</html>
