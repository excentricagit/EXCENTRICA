<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turismo - Editor Excentrica</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/editor/editor.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #poi-map {
            width: 100%;
            height: 140px;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            z-index: 1;
        }
        .map-hint {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.5);
            text-align: center;
            margin-top: 0.25rem;
        }
        .leaflet-control-zoom a { color: #333 !important; }

        /* Address autocomplete */
        .address-wrapper { position: relative; }
        .address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1e1e1e;
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .address-suggestions.active { display: block; }
        .address-suggestion {
            padding: 0.6rem 0.8rem;
            cursor: pointer;
            font-size: 0.8rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: background 0.2s;
        }
        .address-suggestion:hover { background: rgba(168, 85, 247, 0.2); }
        .address-suggestion:last-child { border-bottom: none; }
        .address-suggestion small { color: rgba(255,255,255,0.5); display: block; margin-top: 2px; }

        .modal-wide { max-width: 1400px; width: 95%; }

        .modal-4col {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.25rem;
        }

        @media (max-width: 1100px) { .modal-4col { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .modal-4col { grid-template-columns: 1fr; } }

        .modal-col {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .modal-col h4 {
            margin: 0 0 0.3rem 0;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 0.4rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .modal-header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .featured-check {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(30, 30, 30, 0.9) 100%) !important;
            border: 1px solid rgba(251, 191, 36, 0.3) !important;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .featured-check:hover {
            border-color: rgba(251, 191, 36, 0.6) !important;
        }
        .featured-check label { color: #fbbf24 !important; }
        .featured-check input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(251, 191, 36, 0.5);
            border-radius: 4px;
            background: rgba(0,0,0,0.3);
            cursor: pointer;
            position: relative;
        }
        .featured-check input[type="checkbox"]:checked {
            background: #fbbf24;
            border-color: #fbbf24;
        }
        .featured-check input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            color: #000;
            font-size: 12px;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .free-check {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(30, 30, 30, 0.9) 100%) !important;
            border: 1px solid rgba(34, 197, 94, 0.3) !important;
            border-radius: 8px;
        }
        .free-check label { color: #22c55e !important; }
        .free-check input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(34, 197, 94, 0.5);
            border-radius: 4px;
            background: rgba(0,0,0,0.3);
            cursor: pointer;
            position: relative;
        }
        .free-check input[type="checkbox"]:checked {
            background: #22c55e;
            border-color: #22c55e;
        }
        .free-check input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            color: #000;
            font-size: 12px;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Image Gallery Upload */
        .image-upload-zone {
            border: 2px dashed rgba(168, 85, 247, 0.4);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(168, 85, 247, 0.05);
        }
        .image-upload-zone:hover {
            border-color: rgba(168, 85, 247, 0.7);
            background: rgba(168, 85, 247, 0.1);
        }
        .image-upload-zone .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .image-upload-zone .text {
            color: rgba(255,255,255,0.6);
            font-size: 0.85rem;
        }
        .image-upload-zone .hint {
            color: rgba(255,255,255,0.4);
            font-size: 0.75rem;
            margin-top: 0.3rem;
        }

        .image-thumbnails {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .image-thumb {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
        }
        .image-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-thumb .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .image-thumb:hover .remove-btn {
            opacity: 1;
        }
        .image-thumb.primary {
            border-color: #a855f7;
        }
        .image-thumb.primary::after {
            content: '‚òÖ';
            position: absolute;
            bottom: 4px;
            left: 4px;
            background: #a855f7;
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 4px;
        }
        .image-thumb.empty {
            border-style: dashed;
            border-color: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.3);
            font-size: 1.5rem;
        }

        .inline-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <a href="/"><span>‚ö°</span> Excentrica</a>
                <span class="admin-badge">EDITOR</span>
            </div>
            <nav class="admin-nav">
                <a href="/editor/" class="admin-nav-item">
                    <span class="icon">üìä</span> Dashboard
                </a>
                <a href="/editor/noticias.html" class="admin-nav-item">
                    <span class="icon">üì∞</span> Noticias
                </a>
                <a href="/editor/productos.html" class="admin-nav-item">
                    <span class="icon">üõí</span> Productos
                </a>
                <a href="/editor/eventos.html" class="admin-nav-item">
                    <span class="icon">üìÖ</span> Eventos
                </a>
                <a href="/editor/categorias.html" class="admin-nav-item">
                    <span class="icon">üìÅ</span> Categor√≠as
                </a>
                <a href="/editor/zonas.html" class="admin-nav-item">
                    <span class="icon">üìç</span> Zonas
                </a>
                <a href="/editor/cine.html" class="admin-nav-item">
                    <span class="icon">üé¨</span> Cine
                </a>
                <a href="/editor/gastronomia.html" class="admin-nav-item">
                    <span class="icon">üçΩÔ∏è</span> Gastronom√≠a
                </a>
                <a href="/editor/alojamiento.html" class="admin-nav-item">
                    <span class="icon">üè®</span> Alojamiento
                </a>
                <a href="/editor/transporte.html" class="admin-nav-item">
                    <span class="icon">üöå</span> Transporte
                </a>
                <a href="/editor/servicios.html" class="admin-nav-item">
                    <span class="icon">üîß</span> Servicios
                </a>
                <a href="/editor/puntos-interes.html" class="admin-nav-item active">
                    <span class="icon">üìç</span> Turismo
                </a>
                <div class="admin-nav-divider"></div>
                <a href="/" class="admin-nav-item">
                    <span class="icon">üè†</span> Volver al sitio
                </a>
                <a href="#" onclick="auth.logout(); return false;" class="admin-nav-item">
                    <span class="icon">üö™</span> Cerrar sesi√≥n
                </a>
            </nav>
        </aside>

        <!-- Main content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1>üìç Puntos de Inter√©s Tur√≠stico</h1>
                <div class="admin-user">
                    <span id="user-name">Editor</span>
                    <button class="btn btn-primary btn-sm" onclick="showCreateModal()">
                        <span>‚ûï</span> Nuevo Punto
                    </button>
                </div>
            </header>

            <div class="admin-content">
                <!-- Stats -->
                <div class="stats-grid mb-4">
                    <div class="stat-card">
                        <div class="stat-icon">üìç</div>
                        <div class="stat-info">
                            <span class="stat-value" id="total-items">0</span>
                            <span class="stat-label">Total</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-info">
                            <span class="stat-value" id="active-items">0</span>
                            <span class="stat-label">Aprobados</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-info">
                            <span class="stat-value" id="pending-items">0</span>
                            <span class="stat-label">Pendientes</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-info">
                            <span class="stat-value" id="featured-items">0</span>
                            <span class="stat-label">Destacados</span>
                        </div>
                    </div>
                </div>

                <!-- Compact filters -->
                <div class="d-flex gap-3 mb-4 flex-wrap">
                    <input type="text" id="search" class="form-control" placeholder="Buscar..." style="max-width: 200px;">
                    <select id="filter-status" class="form-control" style="max-width: 150px;">
                        <option value="">Todos los estados</option>
                        <option value="pending">Pendientes</option>
                        <option value="approved">Aprobados</option>
                        <option value="rejected">Rechazados</option>
                    </select>
                    <select id="filter-category" class="form-control" style="max-width: 150px;">
                        <option value="">Todas categor√≠as</option>
                    </select>
                    <button class="btn btn-outline btn-sm" onclick="resetFilters()">Limpiar</button>
                </div>

                <!-- Table -->
                <div class="card">
                    <div class="card-body">
                        <div id="items-table-container">
                            <div class="text-center p-4">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal backdrop -->
    <div class="modal-backdrop" id="modal-backdrop" onclick="closeModal()"></div>

    <!-- Modal -->
    <div class="modal modal-wide" id="item-modal">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">Nuevo Punto de Inter√©s</h3>
            <div class="modal-header-actions">
                <button type="button" class="btn btn-outline btn-sm" onclick="closeModal()">Cancelar</button>
                <button type="submit" form="item-form" class="btn btn-primary btn-sm">Guardar</button>
            </div>
        </div>
        <div class="modal-body" style="padding: 1rem !important;">
            <form id="item-form" onsubmit="saveItem(event)">
                <input type="hidden" id="item-id">
                <input type="hidden" id="item-images-data">

                <div class="modal-4col">
                    <!-- Columna 1: Informaci√≥n b√°sica -->
                    <div class="modal-col">
                        <h4>Informaci√≥n</h4>
                        <div class="form-group">
                            <label for="item-nombre">Nombre *</label>
                            <input type="text" id="item-nombre" class="form-control" required placeholder="Ej: Plaza Principal">
                        </div>
                        <div class="form-group">
                            <label for="item-categoria">Categor√≠a</label>
                            <select id="item-categoria" class="form-control">
                                <option value="">Sin categor√≠a</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="item-descripcion">Descripci√≥n *</label>
                            <textarea id="item-descripcion" class="form-control" rows="2" required placeholder="Descripci√≥n..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="item-estado">Estado</label>
                            <select id="item-estado" class="form-control">
                                <option value="pending">Pendiente</option>
                                <option value="approved">Aprobado</option>
                                <option value="rejected">Rechazado</option>
                            </select>
                        </div>
                        <div class="form-group featured-check" style="padding: 0.5rem 0.75rem;">
                            <label style="display: flex; align-items: center; gap: 0.6rem; cursor: pointer; font-size: 0.85rem;">
                                <input type="checkbox" id="item-destacado">
                                <span>‚≠ê Destacar</span>
                            </label>
                        </div>
                    </div>

                    <!-- Columna 2: Horarios y entrada -->
                    <div class="modal-col">
                        <h4>Horarios y Entrada</h4>
                        <div class="form-group">
                            <label for="item-horarios">Horarios</label>
                            <input type="text" id="item-horarios" class="form-control" placeholder="Lun-Dom 8-20hs">
                        </div>
                        <div class="form-group">
                            <label for="item-precio">Entrada $</label>
                            <input type="number" id="item-precio" class="form-control" step="0.01" min="0" placeholder="0">
                        </div>
                        <div class="form-group free-check" style="padding: 0.5rem 0.75rem;">
                            <label style="display: flex; align-items: center; gap: 0.6rem; cursor: pointer; font-size: 0.85rem;">
                                <input type="checkbox" id="item-gratis" checked>
                                <span>üéüÔ∏è Gratuito</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="item-telefono">Tel√©fono</label>
                            <input type="tel" id="item-telefono" class="form-control" placeholder="0385-4123456">
                        </div>
                        <div class="form-group">
                            <label for="item-web">Sitio Web</label>
                            <input type="url" id="item-web" class="form-control" placeholder="https://...">
                        </div>
                    </div>

                    <!-- Columna 3: Ubicaci√≥n -->
                    <div class="modal-col">
                        <h4>Ubicaci√≥n</h4>
                        <div class="form-group">
                            <label for="item-provincia">Provincia</label>
                            <select id="item-provincia" class="form-control" onchange="filterZonesByProvince()">
                                <option value="">Seleccionar provincia</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="item-zona">Zona</label>
                            <select id="item-zona" class="form-control">
                                <option value="">Primero selecciona provincia</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="item-direccion">Direcci√≥n <span id="address-loading" style="display:none; color:#a855f7; font-size:0.7rem;">buscando...</span></label>
                            <div class="address-wrapper">
                                <input type="text" id="item-direccion" class="form-control" placeholder="Escrib√≠ o arrastr√° el marcador" autocomplete="off">
                                <div class="address-suggestions" id="address-suggestions"></div>
                            </div>
                        </div>
                        <div id="poi-map"></div>
                        <p class="map-hint">Arrastra el marcador para ubicar</p>
                        <input type="hidden" id="item-latitud">
                        <input type="hidden" id="item-longitud">
                    </div>

                    <!-- Columna 4: Im√°genes -->
                    <div class="modal-col">
                        <h4>Im√°genes</h4>
                        <input type="file" id="item-image-input" accept="image/*" multiple style="display:none" onchange="handleImageUpload(this)">
                        <div class="image-upload-zone" onclick="document.getElementById('item-image-input').click()" style="padding: 1rem;">
                            <div class="icon">üì∑</div>
                            <div class="text">Click para subir</div>
                            <div class="hint">Max 5 fotos</div>
                        </div>
                        <div class="image-thumbnails" id="image-thumbnails">
                            <div class="image-thumb empty">+</div>
                            <div class="image-thumb empty">+</div>
                            <div class="image-thumb empty">+</div>
                            <div class="image-thumb empty">+</div>
                            <div class="image-thumb empty">+</div>
                        </div>
                        <p style="font-size: 0.65rem; color: rgba(255,255,255,0.4); margin-top: 0.4rem; text-align: center;">
                            Primera = principal (‚òÖ)
                        </p>
                        <div class="form-group" style="margin-top: 0.5rem;">
                            <label for="item-accesibilidad">‚ôø Accesibilidad</label>
                            <textarea id="item-accesibilidad" class="form-control" rows="2" placeholder="Rampas, ba√±os adaptados..."></textarea>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/components.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        if (!auth.getUser()) {
            // Redirect handled by auth
        }

        document.getElementById('user-name').textContent = auth.getUser()?.name || 'Editor';

        let allItems = [];
        let filteredItems = [];
        let categories = [];
        let zones = [];
        let provinces = [];
        let currentImages = []; // Array of base64 images
        let poiMap = null;
        let poiMarker = null;

        async function loadData() {
            try {
                const [itemsResponse, categoriesResponse, zonesResponse, provincesResponse] = await Promise.all([
                    api.getAdminPoi({ limit: 500 }),
                    api.getCategories('turismo'),
                    api.getZones(),
                    api.getProvinces()
                ]);

                if (itemsResponse.success) {
                    allItems = itemsResponse.data.items || itemsResponse.data || [];
                    applyFilters();
                    updateStats();
                }

                if (categoriesResponse.success) {
                    categories = categoriesResponse.data.items || categoriesResponse.data || [];
                    renderCategoryOptions();
                }

                if (zonesResponse.success) {
                    zones = zonesResponse.data.items || zonesResponse.data || [];
                }

                if (provincesResponse.success) {
                    provinces = provincesResponse.data.items || provincesResponse.data || [];
                    renderProvinceOptions();
                }
            } catch (e) {
                console.error('Error loading data:', e);
                Components.toast('Error cargando datos', 'error');
            }
        }

        function renderCategoryOptions() {
            const selects = [document.getElementById('item-categoria'), document.getElementById('filter-category')];
            selects.forEach((select, idx) => {
                if (!select) return;
                const defaultOpt = idx === 0 ? '<option value="">Sin categor√≠a</option>' : '<option value="">Todas categor√≠as</option>';
                select.innerHTML = defaultOpt + categories.map(cat =>
                    `<option value="${cat.id}">${cat.name}</option>`
                ).join('');
            });
        }

        function renderProvinceOptions() {
            const select = document.getElementById('item-provincia');
            select.innerHTML = '<option value="">Seleccionar provincia</option>' +
                provinces.map(prov => `<option value="${prov.id}">${prov.name}</option>`).join('');
        }

        function filterZonesByProvince() {
            const provinceId = document.getElementById('item-provincia').value;
            const zoneSelect = document.getElementById('item-zona');

            if (!provinceId) {
                zoneSelect.innerHTML = '<option value="">Primero selecciona provincia</option>';
                return;
            }

            const filteredZones = zones.filter(z => z.province_id == provinceId);
            zoneSelect.innerHTML = '<option value="">Seleccionar zona</option>' +
                filteredZones.map(zone => `<option value="${zone.id}">${zone.name}</option>`).join('');
        }

        function renderZoneOptions(selectedZoneId = null) {
            // If editing and we have a zone, select its province first
            if (selectedZoneId) {
                const zone = zones.find(z => z.id == selectedZoneId);
                if (zone && zone.province_id) {
                    document.getElementById('item-provincia').value = zone.province_id;
                    filterZonesByProvince();
                    document.getElementById('item-zona').value = selectedZoneId;
                    return;
                }
            }
            // Default: show placeholder
            const zoneSelect = document.getElementById('item-zona');
            zoneSelect.innerHTML = '<option value="">Primero selecciona provincia</option>';
        }

        function applyFilters() {
            const search = document.getElementById('search').value.toLowerCase();
            const status = document.getElementById('filter-status').value;
            const categoryId = document.getElementById('filter-category').value;

            filteredItems = allItems.filter(item => {
                const matchSearch = !search ||
                    (item.name && item.name.toLowerCase().includes(search)) ||
                    (item.description && item.description.toLowerCase().includes(search));
                const matchStatus = !status || item.status === status;
                const matchCategory = !categoryId || item.category_id == categoryId;
                return matchSearch && matchStatus && matchCategory;
            });

            renderTable();
        }

        function renderTable() {
            const container = document.getElementById('items-table-container');
            if (filteredItems.length === 0) {
                container.innerHTML = '<p class="text-center text-muted p-4">No hay puntos de inter√©s</p>';
                return;
            }

            container.innerHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Lugar</th>
                            <th>Zona</th>
                            <th>Categor√≠a</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredItems.map(item => `
                            <tr>
                                <td>
                                    <strong>${item.featured ? '‚≠ê ' : ''}${item.name}</strong>
                                    ${item.description ? `<br><small class="text-muted">${truncate(item.description, 50)}</small>` : ''}
                                </td>
                                <td>${item.zone_name || '-'}</td>
                                <td><span class="badge badge-secondary">${item.category_name || '-'}</span></td>
                                <td>
                                    <span class="badge badge-${getStatusBadgeClass(item.status)}">
                                        ${getStatusLabel(item.status)}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group">
                                        ${item.status === 'pending' ? `
                                            <button class="btn btn-sm btn-success" onclick="approveItem(${item.id})" title="Aprobar">‚úÖ</button>
                                            <button class="btn btn-sm btn-danger" onclick="rejectItem(${item.id})" title="Rechazar">‚ùå</button>
                                        ` : ''}
                                        <button class="btn btn-sm btn-outline" onclick="editItem(${item.id})" title="Editar">‚úèÔ∏è</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})" title="Eliminar">üóëÔ∏è</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function updateStats() {
            document.getElementById('total-items').textContent = allItems.length;
            document.getElementById('active-items').textContent = allItems.filter(i => i.status === 'approved').length;
            document.getElementById('pending-items').textContent = allItems.filter(i => i.status === 'pending').length;
            document.getElementById('featured-items').textContent = allItems.filter(i => i.featured).length;
        }

        function getStatusBadgeClass(status) {
            return { pending: 'warning', approved: 'success', rejected: 'danger' }[status] || 'secondary';
        }

        function getStatusLabel(status) {
            return { pending: 'Pendiente', approved: 'Aprobado', rejected: 'Rechazado' }[status] || status;
        }

        function truncate(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function resetFilters() {
            document.getElementById('search').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-category').value = '';
            applyFilters();
        }

        async function approveItem(itemId) {
            if (!confirm('¬øAprobar este lugar?')) return;
            try {
                const response = await api.updatePoi(itemId, { status: 'approved' });
                if (response.success) {
                    Components.toast('Lugar aprobado', 'success');
                    loadData();
                }
            } catch (e) {
                Components.toast('Error aprobando', 'error');
            }
        }

        async function rejectItem(itemId) {
            if (!confirm('¬øRechazar este lugar?')) return;
            try {
                const response = await api.updatePoi(itemId, { status: 'rejected' });
                if (response.success) {
                    Components.toast('Lugar rechazado', 'success');
                    loadData();
                }
            } catch (e) {
                Components.toast('Error rechazando', 'error');
            }
        }

        async function deleteItem(itemId) {
            if (!confirm('¬øEliminar este lugar? Esta acci√≥n no se puede deshacer.')) return;
            try {
                const response = await api.deletePoi(itemId);
                if (response.success) {
                    Components.toast('Lugar eliminado', 'success');
                    loadData();
                }
            } catch (e) {
                Components.toast('Error eliminando', 'error');
            }
        }

        // Image handling
        function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function handleImageUpload(input) {
            const files = Array.from(input.files);
            if (!files.length) return;

            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            const remaining = 5 - currentImages.length;

            if (remaining <= 0) {
                Components.toast('Ya tienes 5 im√°genes', 'warning');
                return;
            }

            const toProcess = files.slice(0, remaining);
            Components.toast(`Procesando ${toProcess.length} imagen(es)...`, 'info');

            for (const file of toProcess) {
                if (!allowedTypes.includes(file.type)) {
                    Components.toast(`${file.name}: tipo no permitido`, 'error');
                    continue;
                }
                if (file.size > 10 * 1024 * 1024) {
                    Components.toast(`${file.name}: muy grande (max 10MB)`, 'error');
                    continue;
                }
                try {
                    const base64 = await compressImage(file, 800, 0.7);
                    currentImages.push(base64);
                } catch (e) {
                    console.error('Error compressing:', e);
                }
            }

            renderThumbnails();
            input.value = '';
            Components.toast('Im√°genes cargadas', 'success');
        }

        function renderThumbnails() {
            const container = document.getElementById('image-thumbnails');
            let html = '';

            for (let i = 0; i < 5; i++) {
                if (currentImages[i]) {
                    html += `
                        <div class="image-thumb ${i === 0 ? 'primary' : ''}">
                            <img src="${currentImages[i]}" alt="Foto ${i + 1}">
                            <button type="button" class="remove-btn" onclick="removeImage(${i})">√ó</button>
                        </div>
                    `;
                } else {
                    html += `<div class="image-thumb empty" onclick="document.getElementById('item-image-input').click()">+</div>`;
                }
            }

            container.innerHTML = html;
        }

        function removeImage(index) {
            currentImages.splice(index, 1);
            renderThumbnails();
        }

        // Toggle precio input based on gratuito checkbox
        function togglePrecioInput() {
            const gratis = document.getElementById('item-gratis').checked;
            const precioInput = document.getElementById('item-precio');
            precioInput.disabled = gratis;
            if (gratis) {
                precioInput.value = '';
                precioInput.style.opacity = '0.5';
                precioInput.style.cursor = 'not-allowed';
            } else {
                precioInput.style.opacity = '1';
                precioInput.style.cursor = '';
            }
        }

        // Event listener for gratuito checkbox
        document.getElementById('item-gratis').addEventListener('change', togglePrecioInput);

        function showCreateModal() {
            document.getElementById('modal-title').textContent = 'Nuevo Punto de Inter√©s';
            document.getElementById('item-form').reset();
            document.getElementById('item-id').value = '';
            document.getElementById('item-estado').value = 'pending';
            document.getElementById('item-gratis').checked = true;
            document.getElementById('item-destacado').checked = false;
            document.getElementById('item-provincia').value = '';
            document.getElementById('item-zona').innerHTML = '<option value="">Primero selecciona provincia</option>';
            togglePrecioInput();
            currentImages = [];
            renderThumbnails();
            openModal();
        }

        function editItem(itemId) {
            const item = allItems.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('modal-title').textContent = 'Editar Punto de Inter√©s';
            document.getElementById('item-id').value = item.id;
            document.getElementById('item-nombre').value = item.name || '';
            document.getElementById('item-descripcion').value = item.description || '';
            document.getElementById('item-categoria').value = item.category_id || '';

            // Set province and zone selectors
            renderZoneOptions(item.zone_id);

            document.getElementById('item-direccion').value = item.address || '';
            document.getElementById('item-latitud').value = item.latitude || '';
            document.getElementById('item-longitud').value = item.longitude || '';
            document.getElementById('item-telefono').value = item.phone || '';
            document.getElementById('item-horarios').value = item.schedule || '';
            document.getElementById('item-precio').value = item.entry_fee || '';
            document.getElementById('item-web').value = item.website || '';
            document.getElementById('item-accesibilidad').value = item.accessibility || '';
            document.getElementById('item-estado').value = item.status || 'pending';
            document.getElementById('item-gratis').checked = item.is_free !== false && item.is_free !== 0;
            document.getElementById('item-destacado').checked = item.featured === 1 || item.featured === true;
            togglePrecioInput();

            // Load images
            currentImages = [];
            if (item.image_url) currentImages.push(item.image_url);
            if (item.images) {
                try {
                    const imgs = typeof item.images === 'string' ? JSON.parse(item.images) : item.images;
                    if (Array.isArray(imgs)) {
                        currentImages = [...currentImages, ...imgs].slice(0, 5);
                    }
                } catch (e) {}
            }
            renderThumbnails();
            openModal();
        }

        async function saveItem(event) {
            event.preventDefault();

            const itemId = document.getElementById('item-id').value;
            const mainImage = currentImages[0] || null;
            const additionalImages = currentImages.slice(1);

            const data = {
                name: document.getElementById('item-nombre').value,
                description: document.getElementById('item-descripcion').value,
                image_url: mainImage,
                images: additionalImages.length > 0 ? additionalImages : null,
                category_id: document.getElementById('item-categoria').value || null,
                zone_id: document.getElementById('item-zona').value || null,
                address: document.getElementById('item-direccion').value || null,
                latitude: document.getElementById('item-latitud').value || null,
                longitude: document.getElementById('item-longitud').value || null,
                phone: document.getElementById('item-telefono').value || null,
                schedule: document.getElementById('item-horarios').value || null,
                entry_fee: document.getElementById('item-precio').value ? parseFloat(document.getElementById('item-precio').value) : 0,
                is_free: document.getElementById('item-gratis').checked,
                website: document.getElementById('item-web').value || null,
                accessibility: document.getElementById('item-accesibilidad').value || null,
                status: document.getElementById('item-estado').value,
                featured: document.getElementById('item-destacado').checked
            };

            try {
                let response;
                if (itemId) {
                    response = await api.updatePoi(itemId, data);
                } else {
                    response = await api.createPoi(data);
                }

                if (response.success) {
                    Components.toast(itemId ? 'Lugar actualizado' : 'Lugar creado', 'success');
                    closeModal();
                    loadData();
                } else {
                    Components.toast(response.error || 'Error guardando', 'error');
                }
            } catch (e) {
                console.error('Error saving:', e);
                Components.toast('Error guardando lugar', 'error');
            }
        }

        function openModal() {
            document.getElementById('item-modal').classList.add('active');
            document.getElementById('modal-backdrop').classList.add('active');
            document.body.style.overflow = 'hidden';
            // Initialize map after modal is visible
            setTimeout(() => initPoiMap(), 200);
        }

        function closeModal() {
            document.getElementById('item-modal').classList.remove('active');
            document.getElementById('modal-backdrop').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Map functions
        function initPoiMap() {
            const lat = parseFloat(document.getElementById('item-latitud').value) || -27.7834;
            const lng = parseFloat(document.getElementById('item-longitud').value) || -64.2642;

            if (poiMap) {
                poiMap.remove();
                poiMap = null;
            }

            poiMap = L.map('poi-map').setView([lat, lng], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OSM'
            }).addTo(poiMap);

            poiMarker = L.marker([lat, lng], { draggable: true }).addTo(poiMap);
            poiMarker.on('dragend', function(e) {
                const pos = e.target.getLatLng();
                document.getElementById('item-latitud').value = pos.lat.toFixed(6);
                document.getElementById('item-longitud').value = pos.lng.toFixed(6);
                reverseGeocode(pos.lat, pos.lng);
            });

            setTimeout(() => poiMap.invalidateSize(), 100);
        }

        async function reverseGeocode(lat, lng) {
            const loading = document.getElementById('address-loading');
            loading.style.display = 'inline';
            try {
                const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
                const data = await resp.json();
                if (data.display_name) {
                    document.getElementById('item-direccion').value = data.display_name.split(',').slice(0, 3).join(',');
                }
            } catch (e) {
                console.error('Geocode error:', e);
            }
            loading.style.display = 'none';
        }

        // Address autocomplete
        let searchTimeout = null;
        const suggestionsEl = document.getElementById('address-suggestions');
        const addressInput = document.getElementById('item-direccion');

        async function searchAddress(query) {
            if (query.length < 3) {
                suggestionsEl.classList.remove('active');
                return;
            }
            const loading = document.getElementById('address-loading');
            loading.style.display = 'inline';
            try {
                // Get selected province name to improve search
                const provinceId = document.getElementById('item-provincia').value;
                const province = provinces.find(p => p.id == provinceId);
                const provinceName = province ? province.name : 'Santiago del Estero';

                // Search with province context
                const searchQuery = `${query}, ${provinceName}, Argentina`;
                const resp = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(searchQuery)}&format=json&limit=5&countrycodes=ar`);
                const results = await resp.json();
                renderSuggestions(results);
            } catch (e) {
                console.error('Search error:', e);
            }
            loading.style.display = 'none';
        }

        function renderSuggestions(results) {
            if (results.length === 0) {
                suggestionsEl.classList.remove('active');
                return;
            }
            suggestionsEl.innerHTML = results.map(r => `
                <div class="address-suggestion" data-lat="${r.lat}" data-lng="${r.lon}">
                    ${r.display_name.split(',').slice(0, 2).join(',')}
                    <small>${r.display_name.split(',').slice(2, 4).join(',')}</small>
                </div>
            `).join('');
            suggestionsEl.classList.add('active');

            // Add click handlers
            suggestionsEl.querySelectorAll('.address-suggestion').forEach(el => {
                el.addEventListener('click', () => selectSuggestion(el));
            });
        }

        function selectSuggestion(el) {
            const lat = parseFloat(el.dataset.lat);
            const lng = parseFloat(el.dataset.lng);
            addressInput.value = el.textContent.trim().split('\n')[0];
            document.getElementById('item-latitud').value = lat.toFixed(6);
            document.getElementById('item-longitud').value = lng.toFixed(6);
            suggestionsEl.classList.remove('active');

            // Move map and marker
            if (poiMap && poiMarker) {
                poiMap.setView([lat, lng], 16);
                poiMarker.setLatLng([lat, lng]);
            }
        }

        addressInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => searchAddress(e.target.value), 400);
        });

        // Close suggestions on click outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.address-wrapper')) {
                suggestionsEl.classList.remove('active');
            }
        });

        // Event listeners
        document.getElementById('search').addEventListener('input', applyFilters);
        document.getElementById('filter-status').addEventListener('change', applyFilters);
        document.getElementById('filter-category').addEventListener('change', applyFilters);

        // Load initial data
        loadData();
    </script>
</body>
</html>
