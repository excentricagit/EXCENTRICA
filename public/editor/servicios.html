<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servicios - Editor Excentrica</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/editor/editor.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .modal-wide { max-width: 1300px; width: 95%; }
        .modal-medium { max-width: 700px; width: 95%; }

        .modal-4col {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.25rem;
        }

        .modal-3col {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.25rem;
        }

        .modal-2col {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
        }

        @media (max-width: 1200px) { .modal-4col { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 900px) { .modal-3col { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 700px) { .modal-2col, .modal-4col { grid-template-columns: 1fr; } }
        @media (max-width: 600px) { .modal-3col { grid-template-columns: 1fr; } }

        .modal-col {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .modal-col h4 {
            color: #a855f7;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin: 0;
            padding: 0.5rem 0.75rem;
            background: linear-gradient(90deg, rgba(168, 85, 247, 0.15) 0%, transparent 100%);
            border-left: 3px solid #a855f7;
            border-radius: 0 6px 6px 0;
            font-weight: 600;
        }

        .modal-col .form-group { margin-bottom: 0; }
        .modal-col .form-group label { font-size: 0.75rem; margin-bottom: 0.2rem; }
        .modal-col .form-control { padding: 0.4rem 0.6rem; font-size: 0.85rem; }
        .modal-col textarea.form-control { min-height: 50px; }

        .image-preview-container {
            width: 100%;
            aspect-ratio: 4/3;
            border: 2px dashed rgba(168, 85, 247, 0.3);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-preview-container:hover {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        .image-preview-container img { width: 100%; height: 100%; object-fit: cover; }
        .image-preview-container .placeholder { color: rgba(255, 255, 255, 0.5); text-align: center; padding: 0.5rem; font-size: 0.8rem; }
        .image-preview-container .placeholder span { font-size: 1.5rem; display: block; margin-bottom: 0.25rem; }

        .featured-check {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(30, 30, 30, 0.9) 100%) !important;
            border: 1px solid rgba(251, 191, 36, 0.3) !important;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .featured-check:hover {
            border-color: rgba(251, 191, 36, 0.6) !important;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.25) 0%, rgba(30, 30, 30, 0.9) 100%) !important;
        }
        .featured-check label { color: #fbbf24 !important; }
        .featured-check input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(251, 191, 36, 0.5);
            border-radius: 4px;
            background: rgba(0,0,0,0.3);
            cursor: pointer;
            position: relative;
        }
        .featured-check input[type="checkbox"]:checked {
            background: #fbbf24;
            border-color: #fbbf24;
        }
        .featured-check input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            color: #000;
            font-size: 12px;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .price-inline {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .badge-pending { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .badge-approved { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .badge-rejected { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .featured-star { color: #fbbf24; }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .service-card {
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .service-card:hover {
            border-color: rgba(168, 85, 247, 0.5);
            transform: translateY(-2px);
        }

        .service-card-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
            background: rgba(0, 0, 0, 0.3);
        }

        .service-card-body { padding: 1rem; }

        .service-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .service-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }

        .service-card-category {
            font-size: 0.75rem;
            color: #a855f7;
            margin: 0.25rem 0;
        }

        .service-card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .service-card-price {
            font-size: 0.9rem;
            color: #22c55e;
            font-weight: 600;
            margin: 0.5rem 0;
        }

        .service-card-actions {
            display: flex;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }

        .service-card-actions .btn { flex: 1; min-width: 70px; }

        #service-map {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            margin-top: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .modal-header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .map-hint {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0.25rem;
            text-align: center;
        }

        .leaflet-control-zoom a {
            background: rgba(30, 30, 30, 0.9) !important;
            color: #fff !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        .service-marker-icon {
            background: transparent !important;
            border: none !important;
        }

        .price-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
        }

        @media (max-width: 500px) {
            .price-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <a href="/"><span>‚ö°</span> Excentrica</a>
                <span class="admin-badge">EDITOR</span>
            </div>
            <nav class="admin-nav">
                <a href="/editor/" class="admin-nav-item">
                    <span class="icon">üìä</span> Dashboard
                </a>
                <a href="/editor/noticias.html" class="admin-nav-item">
                    <span class="icon">üì∞</span> Noticias
                </a>
                <a href="/editor/productos.html" class="admin-nav-item">
                    <span class="icon">üõí</span> Productos
                </a>
                <a href="/editor/eventos.html" class="admin-nav-item">
                    <span class="icon">üìÖ</span> Eventos
                </a>
                <a href="/editor/categorias.html" class="admin-nav-item">
                    <span class="icon">üìÅ</span> Categor√≠as
                </a>
                <a href="/editor/zonas.html" class="admin-nav-item">
                    <span class="icon">üìç</span> Zonas
                </a>
                <a href="/editor/cine.html" class="admin-nav-item">
                    <span class="icon">üé¨</span> Cine
                </a>
                <a href="/editor/gastronomia.html" class="admin-nav-item">
                    <span class="icon">üçΩÔ∏è</span> Gastronom√≠a
                </a>
                <a href="/editor/alojamiento.html" class="admin-nav-item">
                    <span class="icon">üè®</span> Alojamiento
                </a>
                <a href="/editor/transporte.html" class="admin-nav-item">
                    <span class="icon">üöå</span> Transporte
                </a>
                <a href="/editor/servicios.html" class="admin-nav-item active">
                    <span class="icon">üîß</span> Servicios
                </a>
                <a href="/editor/puntos-interes.html" class="admin-nav-item">
                    <span class="icon">üìç</span> Turismo
                </a>
                <div class="admin-nav-divider"></div>
                <a href="/" class="admin-nav-item">
                    <span class="icon">üè†</span> Volver al sitio
                </a>
                <a href="#" onclick="auth.logout(); return false;" class="admin-nav-item">
                    <span class="icon">üö™</span> Cerrar sesi√≥n
                </a>
            </nav>
        </aside>

        <!-- Main content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1>üîß Servicios Profesionales</h1>
                <div class="admin-user">
                    <span id="user-name">Editor</span>
                    <button class="btn btn-primary btn-sm" onclick="showCreateModal()">
                        <span>‚ûï</span> Nuevo Servicio
                    </button>
                </div>
            </header>

            <div class="admin-content">
                <div class="stats-grid mb-4">
                    <div class="stat-card">
                        <div class="stat-icon">üîß</div>
                        <div class="stat-info">
                            <span class="stat-value" id="stat-total">0</span>
                            <span class="stat-label">Total</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-info">
                            <span class="stat-value" id="stat-approved">0</span>
                            <span class="stat-label">Aprobados</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-info">
                            <span class="stat-value" id="stat-pending">0</span>
                            <span class="stat-label">Pendientes</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-info">
                            <span class="stat-value" id="stat-featured">0</span>
                            <span class="stat-label">Destacados</span>
                        </div>
                    </div>
                </div>

                <!-- Compact filters -->
                <div class="d-flex gap-3 mb-4 flex-wrap">
                    <input type="text" id="search" class="form-control" placeholder="Buscar..." style="max-width: 200px;" oninput="applyFilters()">
                    <select id="filter-status" class="form-control" style="max-width: 150px;" onchange="applyFilters()">
                        <option value="">Todos los estados</option>
                        <option value="pending">Pendientes</option>
                        <option value="approved">Aprobados</option>
                        <option value="rejected">Rechazados</option>
                    </select>
                    <select id="filter-category" class="form-control" style="max-width: 150px;" onchange="applyFilters()">
                        <option value="">Todas las categor√≠as</option>
                    </select>
                    <select id="filter-zone" class="form-control" style="max-width: 150px;" onchange="applyFilters()">
                        <option value="">Todas las zonas</option>
                    </select>
                    <button class="btn btn-outline btn-sm" onclick="resetFilters()">
                        Limpiar
                    </button>
                </div>

                <div id="services-container" class="service-grid">
                    <p class="text-center text-muted p-4">Cargando servicios...</p>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-backdrop" id="modal-backdrop" onclick="closeAllModals()"></div>

    <!-- Modal Service -->
    <div class="modal modal-wide" id="service-modal">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">Nuevo Servicio</h3>
            <div class="modal-header-actions">
                <button type="button" class="btn btn-outline btn-sm" onclick="closeModal()">Cancelar</button>
                <button type="submit" form="service-form" class="btn btn-primary btn-sm">Guardar</button>
            </div>
        </div>
        <div class="modal-body" style="padding: 1rem !important;">
            <form id="service-form" onsubmit="saveService(event)">
                <input type="hidden" id="item-id">
                <div class="modal-4col">
                    <!-- Columna 1: Informaci√≥n del Servicio -->
                    <div class="modal-col">
                        <h4>Informaci√≥n</h4>
                        <div class="form-group">
                            <label for="item-title">T√≠tulo *</label>
                            <input type="text" id="item-title" class="form-control" required placeholder="Ej: Plomer√≠a Juan">
                        </div>
                        <div class="form-group">
                            <label for="item-category">Categor√≠a *</label>
                            <select id="item-category" class="form-control" required>
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="item-description">Descripci√≥n</label>
                            <textarea id="item-description" class="form-control" rows="2" placeholder="Descripci√≥n..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="item-experience">A√±os Exp.</label>
                            <input type="number" id="item-experience" class="form-control" placeholder="5" min="0">
                        </div>
                        <div class="form-group">
                            <label for="item-schedule">Horarios</label>
                            <input type="text" id="item-schedule" class="form-control" placeholder="Lun-Vie 8-18hs">
                        </div>
                        <div class="form-group">
                            <label for="item-status">Estado</label>
                            <select id="item-status" class="form-control">
                                <option value="pending">Pendiente</option>
                                <option value="approved">Aprobado</option>
                                <option value="rejected">Rechazado</option>
                            </select>
                        </div>
                        <div class="form-group featured-check" style="padding: 0.6rem 0.75rem; border-radius: 8px;">
                            <label style="display: flex; align-items: center; gap: 0.6rem; cursor: pointer; font-size: 0.85rem; font-weight: 500;">
                                <input type="checkbox" id="item-featured">
                                <span>‚≠ê Destacar servicio</span>
                            </label>
                        </div>
                    </div>

                    <!-- Columna 2: Contacto -->
                    <div class="modal-col">
                        <h4>Contacto</h4>
                        <div class="form-group">
                            <label for="item-phone">Tel√©fono</label>
                            <input type="tel" id="item-phone" class="form-control" placeholder="0385-4123456">
                        </div>
                        <div class="form-group">
                            <label for="item-whatsapp">WhatsApp</label>
                            <input type="tel" id="item-whatsapp" class="form-control" placeholder="3854123456">
                        </div>
                        <div class="form-group">
                            <label for="item-email">Email</label>
                            <input type="email" id="item-email" class="form-control" placeholder="contacto@email.com">
                        </div>
                        <div class="form-group">
                            <label for="item-instagram">Instagram</label>
                            <input type="text" id="item-instagram" class="form-control" placeholder="@usuario">
                        </div>
                        <div class="form-group">
                            <label for="item-facebook">Facebook</label>
                            <input type="text" id="item-facebook" class="form-control" placeholder="facebook.com/pagina">
                        </div>
                        <h4 style="margin-top: 0.3rem;">Precios</h4>
                        <div class="price-inline">
                            <div class="form-group">
                                <label for="item-price-from">Desde $</label>
                                <input type="number" id="item-price-from" class="form-control" placeholder="1000" min="0">
                            </div>
                            <div class="form-group">
                                <label for="item-price-to">Hasta $</label>
                                <input type="number" id="item-price-to" class="form-control" placeholder="5000" min="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="item-price-unit">Unidad</label>
                            <select id="item-price-unit" class="form-control">
                                <option value="">-</option>
                                <option value="hora">Por hora</option>
                                <option value="trabajo">Por trabajo</option>
                                <option value="metro">Por metro</option>
                                <option value="visita">Por visita</option>
                            </select>
                        </div>
                    </div>

                    <!-- Columna 3: Ubicaci√≥n -->
                    <div class="modal-col">
                        <h4>Ubicaci√≥n</h4>
                        <div class="form-group">
                            <label for="item-zone">Zona</label>
                            <select id="item-zone" class="form-control">
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="item-address">Direcci√≥n <span id="address-loading" style="display: none; color: #a855f7; font-size: 0.7rem;">...</span></label>
                            <input type="text" id="item-address" class="form-control" placeholder="Arrastra el marcador">
                            <input type="hidden" id="item-latitude">
                            <input type="hidden" id="item-longitude">
                        </div>
                        <div id="service-map" style="height: 200px;"></div>
                        <p class="map-hint">Arrastra el marcador para ubicar</p>
                    </div>

                    <!-- Columna 4: Imagen -->
                    <div class="modal-col">
                        <h4>Imagen</h4>
                        <input type="file" id="item-image-file" accept="image/*" style="display:none" onchange="handleImageUpload(this)">
                        <input type="hidden" id="item-image-url">
                        <div class="image-preview-container" style="height: 280px; aspect-ratio: auto;" onclick="document.getElementById('item-image-file').click()">
                            <div class="placeholder" id="image-preview">
                                <span>üì∑</span>Click para subir imagen
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Provider -->
    <div class="modal modal-medium" id="provider-modal">
        <div class="modal-header" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(30, 30, 30, 0.95) 100%);">
            <h3 class="modal-title">ü™™ Datos del Proveedor</h3>
            <span class="modal-close" onclick="closeProviderModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p id="provider-service-name" style="color: rgba(255,255,255,0.5); margin-bottom: 1rem; font-size: 0.85rem;"></p>
            <input type="hidden" id="provider-service-id">
            <div class="modal-2col">
                <div class="modal-col">
                    <h4 style="color: #ef4444;">Informacion Personal</h4>
                    <div class="form-group">
                        <label for="provider-fullname">Nombre Completo *</label>
                        <input type="text" id="provider-fullname" class="form-control" placeholder="Juan Carlos Perez">
                    </div>
                    <div class="form-group">
                        <label for="provider-dni">DNI</label>
                        <input type="text" id="provider-dni" class="form-control" placeholder="12345678">
                    </div>
                    <div class="form-group">
                        <label for="provider-address">Direccion Personal</label>
                        <input type="text" id="provider-address" class="form-control" placeholder="Av. Belgrano 123">
                    </div>
                    <div class="form-group">
                        <label for="provider-phone">Telefono Personal</label>
                        <input type="tel" id="provider-phone" class="form-control" placeholder="3854000000">
                    </div>
                    <div class="form-group">
                        <label for="provider-notes">Notas (interno)</label>
                        <textarea id="provider-notes" class="form-control" rows="2" placeholder="Observaciones..."></textarea>
                    </div>
                </div>
                <div class="modal-col">
                    <h4 style="color: #ef4444;">Fotos de Documentacion</h4>
                    <div class="form-group">
                        <label>Foto 1 (DNI frente)</label>
                        <input type="file" id="provider-photo1-file" accept="image/*" style="display:none" onchange="handleProviderPhoto(1, this)">
                        <div class="image-preview-container" style="aspect-ratio: 16/10; height: 120px;" onclick="document.getElementById('provider-photo1-file').click()">
                            <div class="placeholder" id="provider-photo1-preview">
                                <span>+</span>Click para cargar
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Foto 2 (DNI dorso)</label>
                        <input type="file" id="provider-photo2-file" accept="image/*" style="display:none" onchange="handleProviderPhoto(2, this)">
                        <div class="image-preview-container" style="aspect-ratio: 16/10; height: 120px;" onclick="document.getElementById('provider-photo2-file').click()">
                            <div class="placeholder" id="provider-photo2-preview">
                                <span>+</span>Click para cargar
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="margin-top: 1rem;">
                <button type="button" class="btn btn-outline" onclick="closeProviderModal()">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-delete-provider" style="display:none;" onclick="deleteProvider()">Eliminar</button>
                <button type="button" class="btn btn-primary" onclick="saveProvider()">Guardar</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/components.js"></script>
    <script>
        if (!auth.getUser()) {
            window.location.href = '/editor/login.html';
        }
        document.getElementById('user-name').textContent = auth.getUser()?.name || 'Editor';

        let allServices = [];
        let filteredServices = [];
        let categories = [];
        let zones = [];
        let serviceMap = null;
        let serviceMarker = null;
        let currentProviderData = { photo1: null, photo2: null };

        async function loadData() {
            try {
                const [servicesRes, categoriesRes, zonesRes] = await Promise.all([
                    api.getAdminServices({ limit: 500 }),
                    api.getCategories('servicios'),
                    api.getZones()
                ]);

                if (servicesRes.success) {
                    allServices = servicesRes.data.items || [];
                    filteredServices = [...allServices];
                }

                if (categoriesRes.success) {
                    categories = categoriesRes.data.items || categoriesRes.data || [];
                    populateCategoryFilters();
                }

                if (zonesRes.success) {
                    zones = zonesRes.data.items || zonesRes.data || [];
                    populateZoneFilters();
                }

                updateStats();
                renderServices();
            } catch (e) {
                console.error('Error loading data:', e);
                Components.toast('Error cargando datos', 'error');
            }
        }

        function populateCategoryFilters() {
            const opts = categories.map(c => `<option value="${c.id}">${c.icon || ''} ${c.name}</option>`).join('');
            document.getElementById('filter-category').innerHTML = '<option value="">Todas las categorias</option>' + opts;
            document.getElementById('item-category').innerHTML = '<option value="">Seleccionar...</option>' + opts;
        }

        function populateZoneFilters() {
            const opts = zones.map(z => `<option value="${z.id}">${z.name}</option>`).join('');
            document.getElementById('filter-zone').innerHTML = '<option value="">Todas las zonas</option>' + opts;
            document.getElementById('item-zone').innerHTML = '<option value="">Seleccionar...</option>' + opts;
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = allServices.length;
            document.getElementById('stat-approved').textContent = allServices.filter(s => s.status === 'approved').length;
            document.getElementById('stat-pending').textContent = allServices.filter(s => s.status === 'pending').length;
            document.getElementById('stat-featured').textContent = allServices.filter(s => s.featured === 1).length;
        }

        function applyFilters() {
            const search = document.getElementById('search').value.toLowerCase();
            const status = document.getElementById('filter-status').value;
            const categoryId = document.getElementById('filter-category').value;
            const zoneId = document.getElementById('filter-zone').value;

            filteredServices = allServices.filter(s => {
                const matchSearch = !search || s.title?.toLowerCase().includes(search) || s.description?.toLowerCase().includes(search);
                const matchStatus = !status || s.status === status;
                const matchCategory = !categoryId || s.category_id == categoryId;
                const matchZone = !zoneId || s.zone_id == zoneId;
                return matchSearch && matchStatus && matchCategory && matchZone;
            });
            renderServices();
        }

        function resetFilters() {
            document.getElementById('search').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-zone').value = '';
            applyFilters();
        }

        function getStatusLabel(status) {
            return { pending: 'Pendiente', approved: 'Aprobado', rejected: 'Rechazado' }[status] || status;
        }

        function formatPrice(from, to, unit) {
            if (!from && !to) return null;
            let price = '$';
            if (from && to) price += `${from} - ${to}`;
            else if (from) price += `${from}+`;
            else price += `hasta ${to}`;
            if (unit) price += ` (${unit})`;
            return price;
        }

        function renderServices() {
            const container = document.getElementById('services-container');
            if (filteredServices.length === 0) {
                container.innerHTML = '<p class="text-center text-muted p-4">No hay servicios registrados</p>';
                return;
            }

            container.innerHTML = filteredServices.map(s => `
                <div class="service-card">
                    ${s.image_url ? `<img src="${s.image_url}" class="service-card-image" alt="${s.title}">` :
                        `<div class="service-card-image" style="display:flex;align-items:center;justify-content:center;font-size:3rem;">${s.category_icon || 'üõ†Ô∏è'}</div>`}
                    <div class="service-card-body">
                        <div class="service-card-header">
                            <div>
                                <h4 class="service-card-title">${s.featured ? '<span class="featured-star">‚≠ê</span> ' : ''}${s.title}</h4>
                                <p class="service-card-category">${s.category_icon || ''} ${s.category_name || 'Sin categoria'}</p>
                            </div>
                            <span class="badge badge-${s.status}">${getStatusLabel(s.status)}</span>
                        </div>
                        <div class="service-card-meta">
                            ${s.zone_name ? `<span>üìç ${s.zone_name}</span>` : ''}
                            ${s.phone ? `<span>üìû ${s.phone}</span>` : ''}
                            ${s.experience_years ? `<span>üèÜ ${s.experience_years} a√±os</span>` : ''}
                        </div>
                        ${formatPrice(s.price_from, s.price_to, s.price_unit) ? `<p class="service-card-price">${formatPrice(s.price_from, s.price_to, s.price_unit)}</p>` : ''}
                        <div class="service-card-actions">
                            ${s.status === 'pending' ? `
                                <button class="btn btn-sm btn-success" onclick="approveService(${s.id})">Aprobar</button>
                                <button class="btn btn-sm btn-danger" onclick="rejectService(${s.id})">Rechazar</button>
                            ` : ''}
                            <button class="btn btn-sm btn-secondary" onclick="openProviderModal(${s.id}, '${s.title.replace(/'/g, "\\'")}')">ü™™ Proveedor</button>
                            <button class="btn btn-sm btn-outline" onclick="editService(${s.id})">Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteService(${s.id})">Borrar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function initServiceMap() {
            const container = document.getElementById('service-map');
            if (!container || serviceMap) return;
            const center = [-27.7833, -64.2667];
            serviceMap = L.map('service-map').setView(center, 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO', subdomains: 'abcd', maxZoom: 19
            }).addTo(serviceMap);

            const markerIcon = L.divIcon({
                className: 'service-marker-icon',
                html: `<div style="width:24px;height:24px;background:linear-gradient(135deg,#a855f7,#7c3aed);border:3px solid #fff;border-radius:50%;box-shadow:0 3px 10px rgba(168,85,247,0.5);cursor:grab;"></div>`,
                iconSize: [24, 24], iconAnchor: [12, 12]
            });

            serviceMarker = L.marker(center, { draggable: true, icon: markerIcon, zIndexOffset: 1000 }).addTo(serviceMap);
            serviceMarker.on('dragend', async function(e) {
                const pos = e.target.getLatLng();
                document.getElementById('item-latitude').value = pos.lat.toFixed(6);
                document.getElementById('item-longitude').value = pos.lng.toFixed(6);
                await reverseGeocode(pos.lat, pos.lng);
            });
            document.getElementById('item-latitude').value = center[0].toFixed(6);
            document.getElementById('item-longitude').value = center[1].toFixed(6);
        }

        async function reverseGeocode(lat, lng) {
            const loading = document.getElementById('address-loading');
            const addressInput = document.getElementById('item-address');
            loading.style.display = 'inline';
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`, { headers: { 'Accept-Language': 'es' } });
                const data = await response.json();
                if (data?.address) {
                    const addr = data.address;
                    let fullAddress = (addr.road || addr.pedestrian || '') + (addr.house_number ? ' ' + addr.house_number : '');
                    if (addr.suburb || addr.neighbourhood) fullAddress += ', ' + (addr.suburb || addr.neighbourhood);
                    addressInput.value = fullAddress || '';
                }
            } catch (e) { console.error('Geocoding error:', e); }
            finally { loading.style.display = 'none'; }
        }

        function destroyServiceMap() {
            if (serviceMap) { serviceMap.remove(); serviceMap = null; serviceMarker = null; }
        }

        function openModal() {
            document.getElementById('service-modal').classList.add('active');
            document.getElementById('modal-backdrop').classList.add('active');
            document.body.style.overflow = 'hidden';
            setTimeout(() => { initServiceMap(); if (serviceMap) serviceMap.invalidateSize(); }, 100);
        }

        function closeModal() {
            document.getElementById('service-modal').classList.remove('active');
            document.getElementById('modal-backdrop').classList.remove('active');
            document.body.style.overflow = '';
            destroyServiceMap();
        }

        function closeAllModals() { closeModal(); closeProviderModal(); }

        function showCreateModal() {
            document.getElementById('modal-title').textContent = 'Nuevo Servicio';
            document.getElementById('service-form').reset();
            document.getElementById('item-id').value = '';
            document.getElementById('item-status').value = 'pending';
            document.getElementById('item-image-url').value = '';
            document.getElementById('image-preview').innerHTML = '<span>+</span>Imagen';
            document.getElementById('image-preview').className = 'placeholder';
            openModal();
        }

        function editService(id) {
            const s = allServices.find(x => x.id === id);
            if (!s) return;
            document.getElementById('modal-title').textContent = 'Editar Servicio';
            document.getElementById('item-id').value = s.id;
            document.getElementById('item-title').value = s.title || '';
            document.getElementById('item-category').value = s.category_id || '';
            document.getElementById('item-description').value = s.description || '';
            document.getElementById('item-experience').value = s.experience_years || '';
            document.getElementById('item-schedule').value = s.schedule || '';
            document.getElementById('item-price-from').value = s.price_from || '';
            document.getElementById('item-price-to').value = s.price_to || '';
            document.getElementById('item-price-unit').value = s.price_unit || '';
            document.getElementById('item-phone').value = s.phone || '';
            document.getElementById('item-whatsapp').value = s.whatsapp || '';
            document.getElementById('item-email').value = s.email || '';
            document.getElementById('item-instagram').value = s.instagram || '';
            document.getElementById('item-facebook').value = s.facebook || '';
            document.getElementById('item-zone').value = s.zone_id || '';
            document.getElementById('item-address').value = s.address || '';
            document.getElementById('item-latitude').value = s.latitude || '';
            document.getElementById('item-longitude').value = s.longitude || '';
            document.getElementById('item-status').value = s.status || 'pending';
            document.getElementById('item-featured').checked = s.featured === 1;
            document.getElementById('item-image-url').value = s.image_url || '';
            const preview = document.getElementById('image-preview');
            if (s.image_url) { preview.innerHTML = `<img src="${s.image_url}" alt="Preview">`; preview.className = ''; }
            else { preview.innerHTML = '<span>+</span>Imagen'; preview.className = 'placeholder'; }
            openModal();
            if (s.latitude && s.longitude) {
                setTimeout(() => {
                    if (serviceMarker && serviceMap) {
                        const pos = [parseFloat(s.latitude), parseFloat(s.longitude)];
                        serviceMarker.setLatLng(pos);
                        serviceMap.setView(pos, 15);
                    }
                }, 200);
            }
        }

        async function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Validar tipo de archivo
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                Components.toast('Tipo de archivo no permitido. Usa JPG, PNG, GIF o WebP', 'error');
                input.value = '';
                return;
            }

            // Validar tama√±o (max 10MB antes de comprimir)
            if (file.size > 10 * 1024 * 1024) {
                Components.toast('El archivo excede el tama√±o m√°ximo de 10MB', 'error');
                input.value = '';
                return;
            }

            try {
                Components.toast('Procesando imagen...', 'info');
                const base64 = await compressImage(file, 800, 0.7);
                document.getElementById('item-image-url').value = base64;
                const preview = document.getElementById('image-preview');
                preview.innerHTML = `<img src="${base64}" alt="Preview">`;
                preview.className = '';
                Components.toast('Imagen cargada correctamente', 'success');
            } catch (e) {
                console.error('Error procesando imagen:', e);
                Components.toast('Error procesando imagen', 'error');
                input.value = '';
            }
        }

        async function saveService(event) {
            event.preventDefault();
            const id = document.getElementById('item-id').value;
            const data = {
                title: document.getElementById('item-title').value.trim(),
                category_id: document.getElementById('item-category').value || null,
                description: document.getElementById('item-description').value.trim() || null,
                experience_years: document.getElementById('item-experience').value || null,
                schedule: document.getElementById('item-schedule').value.trim() || null,
                price_from: document.getElementById('item-price-from').value || null,
                price_to: document.getElementById('item-price-to').value || null,
                price_unit: document.getElementById('item-price-unit').value || null,
                phone: document.getElementById('item-phone').value.trim() || null,
                whatsapp: document.getElementById('item-whatsapp').value.trim() || null,
                email: document.getElementById('item-email').value.trim() || null,
                instagram: document.getElementById('item-instagram').value.trim() || null,
                facebook: document.getElementById('item-facebook').value.trim() || null,
                zone_id: document.getElementById('item-zone').value || null,
                address: document.getElementById('item-address').value.trim() || null,
                latitude: document.getElementById('item-latitude').value || null,
                longitude: document.getElementById('item-longitude').value || null,
                status: document.getElementById('item-status').value,
                featured: document.getElementById('item-featured').checked,
                image_url: document.getElementById('item-image-url').value || null
            };
            if (!data.title) { Components.toast('El titulo es requerido', 'error'); return; }
            try {
                const res = id ? await api.updateService(id, data) : await api.createService(data);
                if (res.success) { Components.toast(id ? 'Servicio actualizado' : 'Servicio creado', 'success'); closeModal(); loadData(); }
                else { Components.toast(res.message || 'Error guardando', 'error'); }
            } catch (e) { Components.toast('Error guardando: ' + e.message, 'error'); }
        }

        async function approveService(id) {
            try {
                const res = await api.updateServiceStatus(id, 'approved');
                if (res.success) { Components.toast('Servicio aprobado', 'success'); loadData(); }
            } catch (e) { Components.toast('Error aprobando', 'error'); }
        }

        async function rejectService(id) {
            try {
                const res = await api.updateServiceStatus(id, 'rejected');
                if (res.success) { Components.toast('Servicio rechazado', 'success'); loadData(); }
            } catch (e) { Components.toast('Error rechazando', 'error'); }
        }

        async function deleteService(id) {
            if (!confirm('Eliminar este servicio?')) return;
            try {
                const res = await api.deleteService(id);
                if (res.success) { Components.toast('Servicio eliminado', 'success'); loadData(); }
            } catch (e) { Components.toast('Error eliminando', 'error'); }
        }

        // PROVIDER
        async function openProviderModal(serviceId, serviceName) {
            document.getElementById('provider-service-id').value = serviceId;
            document.getElementById('provider-service-name').textContent = `Servicio: ${serviceName}`;
            document.getElementById('provider-fullname').value = '';
            document.getElementById('provider-dni').value = '';
            document.getElementById('provider-address').value = '';
            document.getElementById('provider-phone').value = '';
            document.getElementById('provider-notes').value = '';
            document.getElementById('provider-photo1-preview').innerHTML = '<span>+</span>Click para cargar';
            document.getElementById('provider-photo1-preview').className = 'placeholder';
            document.getElementById('provider-photo2-preview').innerHTML = '<span>+</span>Click para cargar';
            document.getElementById('provider-photo2-preview').className = 'placeholder';
            currentProviderData = { photo1: null, photo2: null };
            document.getElementById('btn-delete-provider').style.display = 'none';

            try {
                const res = await api.getServiceProvider(serviceId);
                if (res.success && res.data) {
                    const p = res.data;
                    document.getElementById('provider-fullname').value = p.full_name || '';
                    document.getElementById('provider-dni').value = p.dni || '';
                    document.getElementById('provider-address').value = p.address || '';
                    document.getElementById('provider-phone').value = p.phone_personal || '';
                    document.getElementById('provider-notes').value = p.notes || '';
                    if (p.photo1) { currentProviderData.photo1 = p.photo1; document.getElementById('provider-photo1-preview').innerHTML = `<img src="${p.photo1}">`; document.getElementById('provider-photo1-preview').className = ''; }
                    if (p.photo2) { currentProviderData.photo2 = p.photo2; document.getElementById('provider-photo2-preview').innerHTML = `<img src="${p.photo2}">`; document.getElementById('provider-photo2-preview').className = ''; }
                    document.getElementById('btn-delete-provider').style.display = 'inline-block';
                }
            } catch (e) { console.error('Error loading provider:', e); }

            document.getElementById('provider-modal').classList.add('active');
            document.getElementById('modal-backdrop').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeProviderModal() {
            document.getElementById('provider-modal').classList.remove('active');
            document.getElementById('modal-backdrop').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Compress image before converting to base64
        function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        const base64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(base64);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function handleProviderPhoto(num, input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) { Components.toast('La imagen no puede superar 5MB', 'error'); return; }
            try {
                const base64 = await compressImage(file, 800, 0.7);
                currentProviderData[`photo${num}`] = base64;
                const preview = document.getElementById(`provider-photo${num}-preview`);
                preview.innerHTML = `<img src="${base64}">`;
                preview.className = '';
            } catch (e) {
                console.error('Error compressing image:', e);
                Components.toast('Error procesando imagen', 'error');
            }
        }

        async function saveProvider() {
            const serviceId = document.getElementById('provider-service-id').value;
            const fullName = document.getElementById('provider-fullname').value.trim();
            if (!fullName) { Components.toast('El nombre completo es requerido', 'error'); return; }
            const data = {
                full_name: fullName,
                dni: document.getElementById('provider-dni').value.trim() || null,
                address: document.getElementById('provider-address').value.trim() || null,
                phone_personal: document.getElementById('provider-phone').value.trim() || null,
                notes: document.getElementById('provider-notes').value.trim() || null,
                photo1: currentProviderData.photo1,
                photo2: currentProviderData.photo2
            };
            try {
                const res = await api.saveServiceProvider(serviceId, data);
                if (res.success) { Components.toast('Datos del proveedor guardados', 'success'); closeProviderModal(); }
                else { Components.toast(res.message || 'Error guardando', 'error'); }
            } catch (e) { Components.toast('Error guardando proveedor', 'error'); }
        }

        async function deleteProvider() {
            if (!confirm('Eliminar los datos del proveedor?')) return;
            const serviceId = document.getElementById('provider-service-id').value;
            try {
                const res = await api.deleteServiceProvider(serviceId);
                if (res.success) { Components.toast('Datos eliminados', 'success'); closeProviderModal(); }
            } catch (e) { Components.toast('Error eliminando', 'error'); }
        }

        loadData();
    </script>
</body>
</html>
