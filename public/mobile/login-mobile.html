<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#A020F0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/images/favicon.png">
    <link rel="apple-touch-icon" href="/assets/icon-192.svg">
    <title>Iniciar Sesion - Excentrica</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/base-mobile.css">
    <link rel="stylesheet" href="/css/layout-mobile.css">
    <link rel="stylesheet" href="/css/components-mobile.css">
    <link rel="stylesheet" href="/css/pages-mobile.css">
</head>
<body class="mobile-app mobile-page-auth">

    <!-- Banner instalacion PWA -->
    <div id="install-banner"></div>

    <!-- Header mobile -->
    <header id="mobile-header"></header>

    <!-- Contenido principal -->
    <main id="mobile-main">
        <div class="mobile-page">
            <div style="text-align: center; padding: 2rem 0;">
                <img src="/assets/logo.png" alt="Excentrica" style="height: 48px; margin-bottom: 1rem;">
                <h1 class="mobile-page-title">Iniciar Sesion</h1>
            </div>

            <form id="login-form">
                <div class="mobile-form-group">
                    <label class="mobile-form-label">Email</label>
                    <input type="email" id="email" class="mobile-form-input" placeholder="tu@email.com" required>
                </div>

                <div class="mobile-form-group">
                    <label class="mobile-form-label">Contraseña</label>
                    <input type="password" id="password" class="mobile-form-input" placeholder="Tu contraseña" required>
                </div>

                <div id="error-message" style="display: none; color: var(--danger); font-size: 0.875rem; margin-bottom: 1rem; text-align: center;"></div>

                <button type="submit" class="mobile-btn mobile-btn-primary mobile-btn-block" id="submit-btn">
                    Iniciar Sesion
                </button>
            </form>

            <div style="text-align: center; margin-top: 1.5rem;">
                <p style="color: var(--text-muted); font-size: 0.875rem;">
                    No tienes cuenta?
                    <a href="/mobile/registro-mobile.html" style="color: var(--primary);">Crear cuenta</a>
                </p>
            </div>
        </div>
    </main>

    <!-- Bottom navigation -->
    <nav id="mobile-bottom-nav"></nav>

    <!-- Scripts reutilizados -->
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>

    <!-- Scripts mobile -->
    <script src="/js/pwa-mobile.js"></script>
    <script src="/js/nav-mobile.js"></script>
    <script src="/js/ui-mobile.js"></script>
    <script src="/js/app-mobile.js"></script>

    <script>
        // Si ya esta logueado, redirigir
        if (MobileApp.isLoggedIn()) {
            window.location.href = '/mobile/perfil-mobile.html';
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('error-message');
            const submitBtn = document.getElementById('submit-btn');

            errorEl.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Ingresando...';

            try {
                const response = await Api.login(email, password);

                if (response.success && response.data && response.data.token) {
                    Auth.setSession(response.data.token, response.data.user);

                    // Redirigir
                    const redirect = Utils.getUrlParam('redirect');
                    window.location.href = redirect || '/mobile/index-mobile.html';
                } else {
                    throw new Error(response.error || 'Credenciales incorrectas');
                }
            } catch (error) {
                errorEl.textContent = error.message || 'Error al iniciar sesion';
                errorEl.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Iniciar Sesion';
            }
        });

        MobileApp.init({ page: 'perfil' });
    </script>
</body>
</html>
