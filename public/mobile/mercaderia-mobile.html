<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#A020F0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/images/favicon.png">
    <link rel="apple-touch-icon" href="/assets/icon-192.png">
    <title>Mercaderia - Excentrica</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/base-mobile.css">
    <link rel="stylesheet" href="/css/layout-mobile.css">
    <link rel="stylesheet" href="/css/components-mobile.css">
    <link rel="stylesheet" href="/css/pages-mobile.css">
</head>
<body class="mobile-app">

    <!-- Banner instalacion PWA -->
    <div id="install-banner"></div>

    <!-- Header mobile -->
    <header id="mobile-header"></header>

    <!-- Contenido principal -->
    <main id="mobile-main">
        <div class="mobile-page mobile-mercaderia">

            <!-- Header Mercaderia -->
            <div class="mercaderia-header">
                <div class="mercaderia-header-top">
                    <h1>Mercaderia</h1>
                    <span id="products-count" class="mercaderia-count"></span>
                </div>
                <p class="mercaderia-subtitle">Compra y vende en tu ciudad</p>
            </div>

            <!-- Filtro Condicion -->
            <div class="mercaderia-filters">
                <button class="mercaderia-filter-chip active" data-condition="all">
                    Todos
                </button>
                <button class="mercaderia-filter-chip" data-condition="new">
                    Nuevos
                </button>
                <button class="mercaderia-filter-chip" data-condition="used">
                    Usados
                </button>
            </div>

            <!-- Filtro Categorias -->
            <div id="category-filters" class="mercaderia-filters mercaderia-filters-categories">
                <button class="mercaderia-filter-chip category active" data-category="all">
                    Todas las categorias
                </button>
                <!-- Se cargan dinamicamente -->
            </div>

            <!-- Grid de productos -->
            <div id="products-grid" class="mercaderia-grid">
                <div class="mobile-loading-inline"><div class="mobile-spinner-sm"></div></div>
            </div>

            <!-- Cargar mas -->
            <div id="load-more-container" class="mercaderia-load-more" style="display: none;">
                <button id="btn-load-more" class="mercaderia-btn-load">
                    Cargar mas productos
                </button>
            </div>

        </div>
    </main>

    <!-- Bottom navigation -->
    <nav id="mobile-bottom-nav"></nav>

    <!-- Scripts reutilizados -->
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>

    <!-- Scripts mobile -->
    <script src="/js/pwa-mobile.js"></script>
    <script src="/js/nav-mobile.js"></script>
    <script src="/js/ui-mobile.js"></script>
    <script src="/js/app-mobile.js"></script>

    <script>
        const MercaderiaPage = {
            products: [],
            categories: [],
            page: 1,
            hasMore: true,
            loading: false,
            conditionFilter: 'all',
            categoryFilter: 'all',

            async init() {
                await this.loadCategories();
                this.setupFilters();
                await this.loadProducts(true);
                this.setupLoadMore();
            },

            async loadCategories() {
                try {
                    const response = await Api.getCategories('productos');
                    if (response.success && response.data) {
                        this.categories = response.data;
                    } else if (Array.isArray(response)) {
                        this.categories = response;
                    }
                    this.renderCategoryFilters();
                } catch (e) {
                    console.error('Error loading categories:', e);
                }
            },

            renderCategoryFilters() {
                const container = document.getElementById('category-filters');

                let html = `
                    <button class="mercaderia-filter-chip category active" data-category="all">
                        Todas
                    </button>
                `;

                this.categories.forEach(cat => {
                    html += `
                        <button class="mercaderia-filter-chip category" data-category="${cat.slug}">
                            ${cat.name}
                        </button>
                    `;
                });

                container.innerHTML = html;

                // Setup event listeners para categorias
                container.querySelectorAll('.mercaderia-filter-chip').forEach(chip => {
                    chip.addEventListener('click', () => {
                        container.querySelectorAll('.mercaderia-filter-chip').forEach(c => c.classList.remove('active'));
                        chip.classList.add('active');
                        this.categoryFilter = chip.dataset.category;
                        this.resetAndLoad();
                    });
                });
            },

            setupFilters() {
                // Filtros de condicion
                const conditionChips = document.querySelectorAll('.mercaderia-filter-chip[data-condition]');
                conditionChips.forEach(chip => {
                    chip.addEventListener('click', () => {
                        conditionChips.forEach(c => c.classList.remove('active'));
                        chip.classList.add('active');
                        this.conditionFilter = chip.dataset.condition;
                        this.resetAndLoad();
                    });
                });
            },

            resetAndLoad() {
                this.products = [];
                this.page = 1;
                this.hasMore = true;
                this.loadProducts(true);
            },

            setupLoadMore() {
                const btn = document.getElementById('btn-load-more');
                btn.addEventListener('click', () => this.loadProducts(false));
            },

            async loadProducts(reset = false) {
                if (this.loading) return;
                this.loading = true;

                const grid = document.getElementById('products-grid');
                const loadMoreContainer = document.getElementById('load-more-container');

                if (reset) {
                    grid.innerHTML = '<div class="mobile-loading-inline"><div class="mobile-spinner-sm"></div></div>';
                }

                try {
                    const params = {
                        page: this.page,
                        limit: 12,
                        status: 'approved'
                    };

                    // Filtro condicion
                    if (this.conditionFilter === 'new') {
                        params.condition = 'new';
                    } else if (this.conditionFilter === 'used') {
                        params.condition = 'used';
                    }

                    // Filtro categoria
                    if (this.categoryFilter !== 'all') {
                        params.category = this.categoryFilter;
                    }

                    const response = await Api.getProducts(params);

                    if (response.success && response.data && response.data.products) {
                        const newProducts = response.data.products;
                        this.products = reset ? newProducts : [...this.products, ...newProducts];
                        this.hasMore = newProducts.length === 12;
                        this.page++;

                        this.render();

                        // Actualizar contador
                        const total = response.data.pagination?.total || this.products.length;
                        document.getElementById('products-count').textContent = `${total} productos`;
                    } else {
                        if (reset) {
                            grid.innerHTML = '<p class="mercaderia-empty">No hay productos disponibles</p>';
                            document.getElementById('products-count').textContent = '0 productos';
                        }
                    }

                    loadMoreContainer.style.display = this.hasMore ? 'block' : 'none';

                } catch (error) {
                    console.error('Error loading products:', error);
                    if (reset) {
                        grid.innerHTML = '<p class="mercaderia-empty">Error al cargar productos</p>';
                    }
                } finally {
                    this.loading = false;
                }
            },

            render() {
                const grid = document.getElementById('products-grid');

                if (this.products.length === 0) {
                    grid.innerHTML = '<p class="mercaderia-empty">No hay productos disponibles</p>';
                    return;
                }

                grid.innerHTML = this.products.map(p => this.renderCard(p)).join('');
            },

            renderCard(product) {
                const image = product.front_image_url || product.image_url || '/images/placeholder.jpg';
                const price = Utils.formatPrice(product.price);
                const hasDiscount = product.original_price && product.original_price > product.price;
                const isNew = product.condition === 'new';

                return `
                    <a href="/mobile/producto-mobile.html?id=${product.id}" class="mercaderia-card">
                        <div class="mercaderia-card-img" style="background-image: url('${image}')">
                            ${isNew ? '<span class="mercaderia-card-badge">Nuevo</span>' : ''}
                            ${hasDiscount ? '<span class="mercaderia-card-discount">Oferta</span>' : ''}
                        </div>
                        <div class="mercaderia-card-info">
                            <h3>${Utils.escapeHtml(product.title)}</h3>
                            <div class="mercaderia-card-price">
                                <span class="mercaderia-price-current">$${price}</span>
                                ${hasDiscount ? `<span class="mercaderia-price-original">$${Utils.formatPrice(product.original_price)}</span>` : ''}
                            </div>
                            ${product.category_name ? `<span class="mercaderia-card-category">${product.category_name}</span>` : ''}
                            ${product.zone_name ? `<span class="mercaderia-card-location">${product.zone_name}</span>` : ''}
                        </div>
                    </a>
                `;
            }
        };

        MobileApp.init({
            page: 'categorias',
            onReady: () => MercaderiaPage.init()
        });
    </script>
</body>
</html>
