<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#A020F0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/images/favicon.png">
    <link rel="apple-touch-icon" href="/assets/icon-192.png">
    <title>Transporte - Excentrica</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/base-mobile.css">
    <link rel="stylesheet" href="/css/layout-mobile.css">
    <link rel="stylesheet" href="/css/components-mobile.css">
    <link rel="stylesheet" href="/css/pages-mobile.css">
</head>
<body class="mobile-app">

    <!-- Banner instalacion PWA -->
    <div id="install-banner"></div>

    <!-- Header mobile -->
    <header id="mobile-header"></header>

    <!-- Contenido principal -->
    <main id="mobile-main">
        <div class="mobile-page mobile-transport">

            <!-- Header Transporte -->
            <div class="transport-header">
                <div class="transport-header-top">
                    <h1>Transporte</h1>
                </div>
                <p class="transport-subtitle">Como moverte en Santiago</p>
            </div>

            <!-- Tabs Publico/Privado -->
            <div class="transport-tabs">
                <button class="transport-tab active" data-type="public">
                    <span class="transport-tab-icon">üöå</span>
                    <span class="transport-tab-label">Colectivos</span>
                    <span class="transport-tab-count" id="public-count">0</span>
                </button>
                <button class="transport-tab" data-type="private">
                    <span class="transport-tab-icon">üöï</span>
                    <span class="transport-tab-label">Privados</span>
                    <span class="transport-tab-count" id="private-count">0</span>
                </button>
            </div>

            <!-- Contenido Colectivos -->
            <div id="public-content" class="transport-content active">
                <div id="bus-list" class="transport-list">
                    <div class="mobile-loading-inline"><div class="mobile-spinner-sm"></div></div>
                </div>
                <div id="bus-load-more" class="transport-load-more" style="display: none;">
                    <button class="transport-btn-load">Ver mas lineas</button>
                </div>
            </div>

            <!-- Contenido Privados -->
            <div id="private-content" class="transport-content">
                <div id="private-list" class="transport-list">
                    <div class="mobile-loading-inline"><div class="mobile-spinner-sm"></div></div>
                </div>
                <div id="private-load-more" class="transport-load-more" style="display: none;">
                    <button class="transport-btn-load">Ver mas servicios</button>
                </div>
            </div>

        </div>
    </main>

    <!-- Bottom Sheet para detalle de colectivo -->
    <div id="bus-detail-sheet" class="transport-sheet">
        <div class="transport-sheet-overlay"></div>
        <div class="transport-sheet-content">
            <div class="transport-sheet-handle"></div>
            <div id="bus-detail-content"></div>
        </div>
    </div>

    <!-- Bottom navigation -->
    <nav id="mobile-bottom-nav"></nav>

    <!-- Scripts reutilizados -->
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>

    <!-- Scripts mobile -->
    <script src="/js/pwa-mobile.js"></script>
    <script src="/js/nav-mobile.js"></script>
    <script src="/js/ui-mobile.js"></script>
    <script src="/js/app-mobile.js"></script>

    <script>
        const TransportPage = {
            currentTab: 'public',
            busLines: [],
            privateTransport: [],
            busPage: 1,
            privatePage: 1,
            busHasMore: true,
            privateHasMore: true,
            loading: false,

            async init() {
                this.setupTabs();
                this.setupLoadMore();
                this.setupSheet();
                await this.loadCounts();
                this.loadBusLines(true);
            },

            setupTabs() {
                document.querySelectorAll('.transport-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const type = tab.dataset.type;
                        if (type === this.currentTab) return;

                        // Update tabs
                        document.querySelectorAll('.transport-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');

                        // Update content
                        document.querySelectorAll('.transport-content').forEach(c => c.classList.remove('active'));
                        document.getElementById(`${type}-content`).classList.add('active');

                        this.currentTab = type;

                        // Load data if needed
                        if (type === 'public' && this.busLines.length === 0) {
                            this.loadBusLines(true);
                        } else if (type === 'private' && this.privateTransport.length === 0) {
                            this.loadPrivate(true);
                        }
                    });
                });
            },

            setupLoadMore() {
                document.querySelector('#bus-load-more .transport-btn-load').addEventListener('click', () => {
                    this.loadBusLines(false);
                });
                document.querySelector('#private-load-more .transport-btn-load').addEventListener('click', () => {
                    this.loadPrivate(false);
                });
            },

            setupSheet() {
                const sheet = document.getElementById('bus-detail-sheet');
                const overlay = sheet.querySelector('.transport-sheet-overlay');

                overlay.addEventListener('click', () => this.closeSheet());

                // Swipe down to close
                let startY = 0;
                const content = sheet.querySelector('.transport-sheet-content');
                content.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                });
                content.addEventListener('touchend', (e) => {
                    const endY = e.changedTouches[0].clientY;
                    if (endY - startY > 100) {
                        this.closeSheet();
                    }
                });
            },

            async loadCounts() {
                try {
                    const [busRes, privateRes] = await Promise.all([
                        Api.getBusLines({ limit: 1 }),
                        Api.getTransport({ limit: 1, type: 'private' })
                    ]);

                    const busCount = busRes.success ? (busRes.data.pagination?.total || 0) : 0;
                    const privateCount = privateRes.success ? (privateRes.data.pagination?.total || 0) : 0;

                    document.getElementById('public-count').textContent = busCount;
                    document.getElementById('private-count').textContent = privateCount;
                } catch (e) {
                    console.error('Error loading counts:', e);
                }
            },

            async loadBusLines(reset = false) {
                if (this.loading) return;
                this.loading = true;

                const list = document.getElementById('bus-list');
                const loadMore = document.getElementById('bus-load-more');

                if (reset) {
                    this.busPage = 1;
                    this.busLines = [];
                    list.innerHTML = '<div class="mobile-loading-inline"><div class="mobile-spinner-sm"></div></div>';
                }

                try {
                    const response = await Api.getBusLines({ page: this.busPage, limit: 10 });

                    if (response.success && response.data && response.data.items) {
                        const newItems = response.data.items;
                        this.busLines = reset ? newItems : [...this.busLines, ...newItems];
                        this.busHasMore = newItems.length === 10;
                        this.busPage++;
                        this.renderBusLines();
                    } else if (reset) {
                        list.innerHTML = '<p class="transport-empty">No hay lineas de colectivo disponibles</p>';
                    }

                    loadMore.style.display = this.busHasMore ? 'block' : 'none';
                } catch (e) {
                    console.error('Error loading bus lines:', e);
                    if (reset) {
                        list.innerHTML = '<p class="transport-empty">Error al cargar lineas</p>';
                    }
                } finally {
                    this.loading = false;
                }
            },

            async loadPrivate(reset = false) {
                if (this.loading) return;
                this.loading = true;

                const list = document.getElementById('private-list');
                const loadMore = document.getElementById('private-load-more');

                if (reset) {
                    this.privatePage = 1;
                    this.privateTransport = [];
                    list.innerHTML = '<div class="mobile-loading-inline"><div class="mobile-spinner-sm"></div></div>';
                }

                try {
                    const response = await Api.getTransport({ page: this.privatePage, limit: 10, type: 'private' });

                    if (response.success && response.data && response.data.items) {
                        const newItems = response.data.items;
                        this.privateTransport = reset ? newItems : [...this.privateTransport, ...newItems];
                        this.privateHasMore = newItems.length === 10;
                        this.privatePage++;
                        this.renderPrivate();
                    } else if (reset) {
                        list.innerHTML = '<p class="transport-empty">No hay servicios privados disponibles</p>';
                    }

                    loadMore.style.display = this.privateHasMore ? 'block' : 'none';
                } catch (e) {
                    console.error('Error loading private transport:', e);
                    if (reset) {
                        list.innerHTML = '<p class="transport-empty">Error al cargar servicios</p>';
                    }
                } finally {
                    this.loading = false;
                }
            },

            renderBusLines() {
                const list = document.getElementById('bus-list');
                if (this.busLines.length === 0) {
                    list.innerHTML = '<p class="transport-empty">No hay lineas disponibles</p>';
                    return;
                }
                list.innerHTML = this.busLines.map(bus => this.renderBusCard(bus)).join('');
            },

            renderPrivate() {
                const list = document.getElementById('private-list');
                if (this.privateTransport.length === 0) {
                    list.innerHTML = '<p class="transport-empty">No hay servicios disponibles</p>';
                    return;
                }
                list.innerHTML = this.privateTransport.map(t => this.renderPrivateCard(t)).join('');
            },

            parseRoute(routeDescription) {
                if (!routeDescription) return { origin: '', destination: '', stops: [] };
                const stops = routeDescription.split(/[,\-\>‚Üí]/).map(s => s.trim()).filter(s => s);
                return {
                    origin: stops[0] || '',
                    destination: stops[stops.length - 1] || '',
                    stops: stops
                };
            },

            formatPrice(price) {
                if (!price) return null;
                return '$' + Number(price).toLocaleString('es-AR');
            },

            renderBusCard(bus) {
                const route = this.parseRoute(bus.route_description);
                const color = bus.color || '#10b981';
                const price = this.formatPrice(bus.price);

                return `
                    <div class="bus-card" onclick="TransportPage.openBusDetail(${bus.id})">
                        <div class="bus-card-left">
                            <div class="bus-line-badge" style="background: ${color};">
                                ${Utils.escapeHtml(bus.line_number) || '?'}
                            </div>
                        </div>
                        <div class="bus-card-center">
                            <h3 class="bus-card-name">${Utils.escapeHtml(bus.name)}</h3>
                            ${route.origin && route.destination ? `
                                <p class="bus-card-route">
                                    <span>${Utils.escapeHtml(route.origin)}</span>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                        <path d="M5 12h14M12 5l7 7-7 7"/>
                                    </svg>
                                    <span>${Utils.escapeHtml(route.destination)}</span>
                                </p>
                            ` : ''}
                            <div class="bus-card-meta">
                                ${price ? `<span class="bus-meta-price">${price}</span>` : ''}
                                ${bus.company ? `<span class="bus-meta-company">${Utils.escapeHtml(bus.company)}</span>` : ''}
                            </div>
                        </div>
                        <div class="bus-card-right">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 18l6-6-6-6"/>
                            </svg>
                        </div>
                    </div>
                `;
            },

            getPrivateIcon(transport) {
                const name = (transport.name || transport.title || '').toLowerCase();
                if (name.includes('taxi')) return 'üöï';
                if (name.includes('remis')) return 'üöó';
                if (name.includes('combi') || name.includes('transfer')) return 'üöê';
                return 'üöï';
            },

            getPrivateType(transport) {
                if (transport.vehicle_type) {
                    const types = { 'remis': 'Remis', 'taxi': 'Taxi', 'uber': 'App', 'particular': 'Particular' };
                    return types[transport.vehicle_type] || 'Transporte';
                }
                const name = (transport.name || transport.title || '').toLowerCase();
                if (name.includes('taxi')) return 'Taxi';
                if (name.includes('remis')) return 'Remis';
                if (name.includes('combi')) return 'Combi';
                return 'Transporte';
            },

            renderPrivateCard(transport) {
                const icon = this.getPrivateIcon(transport);
                const type = this.getPrivateType(transport);
                const name = transport.title || transport.name;
                const is24h = transport.is_24h || (transport.schedule && transport.schedule.toLowerCase().includes('24'));
                const phone = transport.phone || transport.whatsapp;

                return `
                    <div class="private-card">
                        <div class="private-card-header">
                            <div class="private-icon">${icon}</div>
                            <div class="private-info">
                                <h3>${Utils.escapeHtml(name)}</h3>
                                <span class="private-type">${type}</span>
                            </div>
                            <div class="private-availability ${is24h ? 'available' : ''}">
                                <span class="availability-dot"></span>
                                ${is24h ? '24hs' : 'Consultar'}
                            </div>
                        </div>
                        ${transport.zone_name ? `
                            <p class="private-zone">üìç ${Utils.escapeHtml(transport.zone_name)}</p>
                        ` : ''}
                        ${phone ? `
                            <div class="private-actions">
                                <button onclick="TransportPage.openWhatsApp('${phone}', '${Utils.escapeHtml(name)}')" class="private-btn-whatsapp">
                                    <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                                    Contactar por WhatsApp
                                </button>
                                <button onclick="TransportPage.callPhone('${phone}')" class="private-btn-call">
                                    üìû Llamar
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            },

            openWhatsApp(phone, name) {
                const cleanNumber = phone.replace(/\D/g, '');
                const fullNumber = cleanNumber.startsWith('549') ? cleanNumber : `549${cleanNumber}`;
                const message = `Hola! Necesito un servicio de transporte. Vi "${name}" en Excentrica.`;
                window.open(`https://wa.me/${fullNumber}?text=${encodeURIComponent(message)}`, '_blank');
            },

            callPhone(phone) {
                window.location.href = `tel:${phone}`;
            },

            async openBusDetail(busId) {
                const sheet = document.getElementById('bus-detail-sheet');
                const content = document.getElementById('bus-detail-content');

                content.innerHTML = '<div class="mobile-loading-inline"><div class="mobile-spinner-sm"></div></div>';
                sheet.classList.add('active');
                document.body.style.overflow = 'hidden';

                try {
                    const response = await Api.get(`/api/bus-lines/${busId}`);
                    if (response.success && response.data) {
                        const bus = response.data;
                        const route = this.parseRoute(bus.route_description);
                        const color = bus.color || '#10b981';
                        const price = this.formatPrice(bus.price);
                        const stops = bus.stops || route.stops.map(s => ({ name: s }));

                        content.innerHTML = `
                            <div class="bus-detail">
                                <div class="bus-detail-header" style="border-color: ${color};">
                                    <div class="bus-detail-badge" style="background: ${color};">
                                        ${Utils.escapeHtml(bus.line_number) || '?'}
                                    </div>
                                    <div class="bus-detail-title">
                                        <h2>${Utils.escapeHtml(bus.name)}</h2>
                                        ${bus.company ? `<p>${Utils.escapeHtml(bus.company)}</p>` : ''}
                                    </div>
                                </div>

                                <div class="bus-detail-info">
                                    ${bus.schedule ? `
                                        <div class="bus-detail-item">
                                            <span class="bus-detail-icon">üïê</span>
                                            <div>
                                                <strong>Horario</strong>
                                                <p>${Utils.escapeHtml(bus.schedule)}</p>
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${price ? `
                                        <div class="bus-detail-item">
                                            <span class="bus-detail-icon">üíµ</span>
                                            <div>
                                                <strong>Tarifa</strong>
                                                <p>${price}</p>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>

                                ${stops.length > 0 ? `
                                    <div class="bus-detail-route">
                                        <h3>üöè Recorrido</h3>
                                        <div class="bus-route-timeline">
                                            ${stops.map((stop, i) => `
                                                <div class="bus-route-stop">
                                                    <div class="bus-route-dot" style="background: ${color};"></div>
                                                    <span>${Utils.escapeHtml(stop.name || stop)}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    } else {
                        content.innerHTML = '<p class="transport-empty">No se pudo cargar la informacion</p>';
                    }
                } catch (e) {
                    console.error('Error loading bus detail:', e);
                    content.innerHTML = '<p class="transport-empty">Error al cargar</p>';
                }
            },

            closeSheet() {
                const sheet = document.getElementById('bus-detail-sheet');
                sheet.classList.remove('active');
                document.body.style.overflow = '';
            }
        };

        MobileApp.init({
            page: 'categorias',
            onReady: () => TransportPage.init()
        });
    </script>
</body>
</html>
